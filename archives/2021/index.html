<!DOCTYPE html>
<html>
<head hexo-theme='https://github.com/volantis-x/hexo-theme-volantis/tree/3.0.0'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
      <meta name="robots" content="noindex,follow">
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
  <title>Archive: 2021 - Yokeso</title>
  

  

  <!-- feed -->
  
    <link rel="alternate" href="/atom.xml" title="Yokeso">
  

  <!-- import meta -->
  

  <!-- link -->
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13/css/all.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  

  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  

  

  <!-- import link -->
  

  
  
    
<link rel="stylesheet" href="/css/style.css">

  

  
  
</head>

<body>
  <header class="l_header shadow blur" style='opacity: 0'>
  <div class='container'>
  <div class='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h m-phone' id="pjax-header-nav-list">
        <li><a class="s-comment fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
            <img no-lazy class='logo' src='https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/blog/Logo-NavBar@3x.png'/>
          
          
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h m-pc'>
          
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/friends/
                  
                  
                  
                    id="friends"
                  >
                  <i class='fas fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>

			<ul class='switcher nav-list-h m-phone'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-rss fa-fw'></i>博客
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/categories/
                  
                  
                  
                    id="categories"
                  >
                  <i class='fas fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/friends/
                  
                  
                  
                    id="friends"
                  >
                  <i class='fas fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

  
  
  
  <div class="cover-wrapper">
    <div class='cover ' style="display: none;">
      <div class='cover-bg lazyload placeholder' data-bg=""></div>
      <div class='cover-body'>
  <div class='a'>
    
      <img no-lazy class='logo' src='https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/blog/Logo-Cover@3x.png'/>
    
    
    
  </div>
  <div class='b'>
    <div class='menu navigation dock'>
      <div class='list-h'>
        
          
            <a href="/v3/getting-started/"
              
              
              id="v3getting-started">
              <i class='fas fa-book fa-fw'></i><p>文档</p>
            </a>
          
            <a href="/faqs/"
              
              
              id="faqs">
              <i class='fas fa-question-circle fa-fw'></i><p>帮助</p>
            </a>
          
            <a href="/examples/"
              
              
              id="examples">
              <i class='fas fa-play-circle fa-fw'></i><p>示例</p>
            </a>
          
            <a href="/contributors/"
              
              
              id="contributors">
              <i class='fas fa-fan fa-spin fa-fw'></i><p>社区</p>
            </a>
          
        
      </div>
    </div>
  </div>
</div>

      <div class="scroll-down" style="display: none;"><i class="fa fa-chevron-down scroll-down-effects"></i></div>
    </div>
  </div>
  


  <div class="l_body">
    <div class='body-wrapper' id="pjax-container">
      
        <!--此文件用来存放一些不方便取值的变量-->
<!--思路大概是将值藏到重加载的区域内-->



<div id="pjax-data" style="display: none">
  <div id="pjax-ispage">false</div>
  <div id="pjax-pageTitle"></div>
  <div id="pjax-enable-cover">true</div>
  <div id="pjax-comment-path">none</div>
  <div id="pjax-comment-placeholder">none</div>
</div>


<script>
  // 处理封面 此时 jquery 还没加载
  if ("blog" == "none") { // 移除封面
    document.getElementsByClassName('cover')[0].style.display = "none"; 
    document.getElementsByClassName('l_body')[0].classList.add("nocover");
    document.getElementsByClassName('l_header', 'cover-wrapper')[0].classList.add("show");
  } else {
    if ("blog" == "blog") { // 半屏
      document.getElementsByClassName('cover')[0].classList.remove("full");
      document.getElementsByClassName('cover')[0].classList.add("half");
      document.getElementsByClassName('scroll-down')[0].style.display = "none";
    } else if ("blog" == "docs") { // 全屏
      document.getElementsByClassName('cover')[0].classList.remove("half");
      document.getElementsByClassName('cover')[0].classList.add("full");
      document.getElementsByClassName('scroll-down')[0].style.display = "";
    }
    document.getElementsByClassName('cover')[0].style.display = "";
    document.getElementsByClassName('l_body', 'show')[0].classList.remove("nocover");
    document.getElementsByClassName('l_header', 'cover-wrapper')[0].classList.remove("show");
  }
</script>


      
      

<div class='l_main'>
	
		
  <section class="post-list ">
    
      
        
          
        
          
        
          
        
          
        
      
    
    
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2021/01/06/scala/">
      scala
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a class='author' href="/" rel="nofollow">
    <img no-lazy src="">
    <p>请设置文章作者</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Jan 6, 2021</p>
  </a>
</div>

            
          
            
              

            
          
            
              
  <div class="new-meta-item browse valine">
    <a class='notlink'>
      <i class="fas fa-eye fa-fw" aria-hidden="true"></i>
      
      <span id="/2021/01/06/scala/" class="leancloud_visitors" data-flag-title="scala">
      <p>
        <span class="leancloud-visitors-count"></span>
      </p>
      </span>
    </a>
  </div>


            
          
            
              
<div class="new-meta-item comments-count">
  
  <a href="/2021/01/06/scala/#comments">
    <i class="fas fa-comment-dots fa-fw"></i>
    <span class="valine-comment-count" data-xid="/2021/01/06/scala/">0</span>
    <span class="leancloud-comments-count">&nbsp;</span>
  </a>
</div>


            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Scala编程方法简化版"><a href="#Scala编程方法简化版" class="headerlink" title="Scala编程方法简化版"></a>Scala编程方法简化版</h2><h3 id="1-变量常量"><a href="#1-变量常量" class="headerlink" title="1.变量常量"></a>1.变量常量</h3><p>字符数字标识符：字母或者下划线开头，<code>$</code>被认作字母</p>
<h6 id="运算符优先级："><a href="#运算符优先级：" class="headerlink" title="运算符优先级："></a>运算符优先级：</h6><p>先乘除后加减</p>
<p>先算数，后移位，最后位运算</p>
<p>指针最优，单目优于双目</p>
<p>var 声明变量，val声明常量</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> hellostr=<span class="string">"Hello World"</span></span><br><span class="line"><span class="comment">//hellostr:string = Hello World</span></span><br><span class="line"><span class="comment">//定义后不能修改</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hellostr1=<span class="string">"Hello World"</span></span><br><span class="line"><span class="comment">//hellostr1:string = Hello World</span></span><br></pre></td></tr></table></figure>

<p>在声明变量和常量不一定需要指定数据类型，没有指明时通过初始值推断。<strong>变量常量必须付初始值，否则会报错</strong></p>
<p>可以用val声明一个元组</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> mr=(<span class="string">"key"</span>,<span class="number">22</span>)</span><br><span class="line"><span class="comment">//mr:(string,int)=(key,22)</span></span><br></pre></td></tr></table></figure>

<p>Scala与Java有相同的变量类型，但是首字母必须大写，因为是对象，例如Int,String,Boolean</p>
<p>可以直接用<code>0x</code>表示16进制，<code>0</code>表示8进制，表示<code>Long</code>用<code>L</code>或者<code>l</code>作为后缀，表示<code>float</code>用<code>F/f</code>否则默认为double</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> x=<span class="number">41</span></span><br><span class="line"><span class="keyword">val</span> x=<span class="number">0x29</span></span><br><span class="line"><span class="keyword">val</span> x=<span class="number">051</span></span><br><span class="line"><span class="comment">//x:Int=41</span></span><br><span class="line"><span class="keyword">val</span> x = <span class="number">0777</span>l</span><br><span class="line"><span class="comment">//x:Long=511</span></span><br><span class="line"><span class="keyword">val</span> f = <span class="number">3.14</span>f</span><br><span class="line"><span class="comment">//f:Float=3.14</span></span><br><span class="line"><span class="keyword">val</span> f=<span class="number">3.14</span><span class="comment">//0.314e1</span></span><br><span class="line"><span class="comment">//f:Double=3.14</span></span><br></pre></td></tr></table></figure>

<p>单字符用‘ ’引用，特殊字符要添加转义字符\，双引号同理</p>
<p>Scala还提供一种原样字符内容输出方法，用<code>“&quot;&quot;</code>的方式来表述</p>
<p><img src="/2021/01/06/scala/image-20210107142102498.png" alt="image-20210107142102498"></p>
<h3 id="2-流程控制与函数"><a href="#2-流程控制与函数" class="headerlink" title="2.流程控制与函数"></a>2.流程控制与函数</h3><h4 id="if语句"><a href="#if语句" class="headerlink" title="if语句"></a>if语句</h4><p>if语句与C++相似，有if,if…else…,if…elseif…else</p>
<p>但if可以作为表达式使用：且可以直接赋值</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> x=<span class="keyword">if</span>(<span class="string">"hello"</span>==<span class="string">"hell"</span>) <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"><span class="comment">//x:Int=0</span></span><br></pre></td></tr></table></figure>

<h4 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h4><h5 id="while"><a href="#while" class="headerlink" title="while"></a>while</h5><p>Scala中while与C++同，唯一不一样的是有返回值且恒为Unit(相当于void，<code>Unit=()</code>)</p>
<h5 id="for"><a href="#for" class="headerlink" title="for"></a>for</h5><p>for循环Scala有自己的风格，基础格式为</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i&lt;-表达式)&#123;</span><br><span class="line">	<span class="comment">//循环语句</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.其中<code>&lt;-</code>称为生成器（generator），而for循环实际上是通过集合遍历来实现循环的</p>
<p> 2.表达式调用<code>RichInt</code>中的<code>to，until</code>方法来实现遍历，例如：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i &lt;- <span class="number">1</span> to <span class="number">5</span>) println(<span class="string">"i="</span>+i)</span><br><span class="line"><span class="comment">//i=1</span></span><br><span class="line"><span class="comment">//i=2</span></span><br><span class="line"><span class="comment">//i=3</span></span><br><span class="line"><span class="comment">//i=4</span></span><br><span class="line"><span class="comment">//i=5</span></span><br></pre></td></tr></table></figure>

<p>3.如果希望集合右开，[1,5)则用<code>1 until 5</code></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i &lt;- <span class="number">1</span> until (<span class="number">10</span>,<span class="number">2</span>)) print(<span class="string">"i="</span>+i)</span><br><span class="line"><span class="comment">//这里的2是步长</span></span><br></pre></td></tr></table></figure>

<p>4.引入break：Scala没有break,continue，但实现类似操作有两种方法</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//引入scala.util.control.Breaks类</span></span><br><span class="line"><span class="comment">//有条件过滤的for循环格式为</span></span><br><span class="line"><span class="keyword">for</span>(i &lt;- <span class="number">1</span> to <span class="number">40</span> <span class="keyword">if</span>(i%<span class="number">4</span>==<span class="number">0</span>);<span class="keyword">if</span>(i%<span class="number">5</span>==<span class="number">0</span>))&#123;<span class="comment">//这里中间是&amp;&amp;关系</span></span><br><span class="line">	println(<span class="string">"i="</span>+i)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//i=20</span></span><br><span class="line"><span class="comment">//i=40</span></span><br></pre></td></tr></table></figure>

<p>5.多重for循环：Scala支持for循环嵌套</p>
<p>6.for表达式：与yield配合使用执行完后有返回值：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x =<span class="keyword">for</span>(i &lt;- <span class="number">1</span> to <span class="number">5</span>) <span class="keyword">yield</span> i/<span class="number">2</span></span><br><span class="line"><span class="comment">//x:scala.collection.immutable.IndexedSeq[Int]=vector(0,1,1,2,2)</span></span><br></pre></td></tr></table></figure>

<h5 id="函数声明，定义和调用"><a href="#函数声明，定义和调用" class="headerlink" title="函数声明，定义和调用"></a>函数声明，定义和调用</h5><h6 id="包："><a href="#包：" class="headerlink" title="包："></a>包：</h6><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义包</span></span><br><span class="line"><span class="comment">//第一种方式</span></span><br><span class="line"><span class="keyword">package</span> com.baidu</span><br><span class="line"><span class="comment">//第二种方式</span></span><br><span class="line"><span class="keyword">package</span> com.dubai1&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//引用包</span></span><br><span class="line"><span class="keyword">import</span> java.awt.<span class="type">Color</span></span><br><span class="line"><span class="keyword">import</span> java.awt_<span class="comment">//引入包内所有成员</span></span><br></pre></td></tr></table></figure>



<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span></span>(&#123;参数列表&#125;):[<span class="keyword">return</span> <span class="class"><span class="keyword">type</span>]</span></span><br><span class="line"><span class="class"><span class="title">//定义</span></span></span><br><span class="line"><span class="class"><span class="title">def</span> <span class="title">fun</span>(<span class="params">&#123;参数列表&#125;</span>)</span>:[<span class="keyword">return</span> <span class="class"><span class="keyword">type</span>]</span>=&#123;</span><br><span class="line">    function body</span><br><span class="line">    <span class="keyword">return</span> [expr]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//调用的格式</span></span><br><span class="line">fun(参数列表)</span><br><span class="line"><span class="comment">//如果函数使用了实例的对象来调用，可以使用类似java的格式 (使用 . 号)：</span></span><br><span class="line">[instance.]fun(参数列表)</span><br></pre></td></tr></table></figure>

<h3 id="类和对象"><a href="#类和对象" class="headerlink" title="类和对象"></a>类和对象</h3><p>Scala用New来创建对象</p>
<p>类的第一个字母大写，方法的第一个字母小写</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io._</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>(<span class="params">val xc: <span class="type">Int</span>, val yc: <span class="type">Int</span></span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> x: <span class="type">Int</span> = xc</span><br><span class="line">   <span class="keyword">var</span> y: <span class="type">Int</span> = yc</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">move</span></span>(dx: <span class="type">Int</span>, dy: <span class="type">Int</span>) &#123;</span><br><span class="line">      x = x + dx</span><br><span class="line">      y = y + dy</span><br><span class="line">      println (<span class="string">"Point x location : "</span> + x);</span><br><span class="line">      println (<span class="string">"Point y location : "</span> + y);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">      <span class="keyword">val</span> pt = <span class="keyword">new</span> <span class="type">Point</span>(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Move to a new location</span></span><br><span class="line">      pt.move(<span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Point x location:20</span></span><br><span class="line"><span class="comment">//Point y location:30</span></span><br></pre></td></tr></table></figure>

<p>类继承：extend  隐形类：impact  </p>
<h3 id="集合：数组、列表与映射"><a href="#集合：数组、列表与映射" class="headerlink" title="集合：数组、列表与映射"></a>集合：数组、列表与映射</h3><h4 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明</span></span><br><span class="line"><span class="keyword">var</span> z:<span class="type">Array</span>[<span class="type">String</span>] = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">String</span>](<span class="number">3</span>)</span><br><span class="line"><span class="keyword">var</span> z = <span class="type">Array</span>(<span class="string">"Hello"</span>，<span class="string">"Cruel"</span>，<span class="string">"World"</span>)</span><br><span class="line"><span class="comment">//赋值</span></span><br><span class="line">z(<span class="number">0</span>)=<span class="string">"Hello"</span>;z(<span class="number">1</span>)=<span class="string">"Cruel"</span>;z(<span class="number">4</span>/<span class="number">2</span>)=<span class="string">"World"</span></span><br><span class="line"><span class="comment">//多维数组</span></span><br><span class="line"><span class="keyword">var</span> myMatrix = ofDim[<span class="type">Int</span>](<span class="number">3</span>,<span class="number">3</span>)</span><br><span class="line"><span class="comment">//简单数组操作：</span></span><br><span class="line"><span class="comment">//合并：</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">concat</span></span>[<span class="type">T</span>]( xss: <span class="type">Array</span>[<span class="type">T</span>]* ): <span class="type">Array</span>[<span class="type">T</span>]</span><br><span class="line"><span class="comment">//复制：</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy</span></span>( src: <span class="type">AnyRef</span>, srcPos: <span class="type">Int</span>, dest: <span class="type">AnyRef</span>, destPos: <span class="type">Int</span>, length: <span class="type">Int</span> ): <span class="type">Unit</span></span><br><span class="line"><span class="comment">//mkString方法：</span></span><br><span class="line">mkString（“&lt;”,”,”,”&gt;”）</span><br><span class="line"><span class="comment">//得用&lt;&gt;所扩，”，”分隔的字符串</span></span><br></pre></td></tr></table></figure>

<h4 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字符串列表</span></span><br><span class="line"><span class="keyword">val</span> site: <span class="type">List</span>[<span class="type">String</span>] = <span class="type">List</span>(<span class="string">"Runoob"</span>, <span class="string">"Google"</span>, <span class="string">"Baidu"</span>)</span><br><span class="line"><span class="comment">// 整型列表</span></span><br><span class="line"><span class="keyword">val</span> nums: <span class="type">List</span>[<span class="type">Int</span>] = <span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="comment">// 二维列表</span></span><br><span class="line"><span class="keyword">val</span> dim: <span class="type">List</span>[<span class="type">List</span>[<span class="type">Int</span>]] =</span><br><span class="line">	<span class="type">List</span>(</span><br><span class="line">		<span class="type">List</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">		<span class="type">List</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">		<span class="type">List</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">	)</span><br><span class="line"><span class="comment">//遍历</span></span><br><span class="line"><span class="keyword">for</span>(i&lt;-<span class="type">List</span>)</span><br><span class="line"><span class="comment">//创建列表</span></span><br><span class="line"><span class="keyword">val</span> nums =<span class="number">1</span>::<span class="number">2</span>::<span class="number">3</span>::<span class="number">4</span>::<span class="type">Nil</span></span><br><span class="line"><span class="comment">//nums:List[Int]=List(1,2,3,4)</span></span><br><span class="line"><span class="comment">//获取第一个第二个，最后一个元素</span></span><br><span class="line"><span class="type">List</span>.head <span class="type">List</span>.tail <span class="type">List</span>.last</span><br><span class="line"><span class="comment">//连接操作</span></span><br><span class="line"><span class="type">List1</span>:::<span class="type">List2</span></span><br><span class="line"><span class="comment">//获取和丢弃</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/01/06/scala/image-20210107152128223.png" alt="image-20210107152128223"></p>
<h4 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h4><p>•Scala中的映射是键/值对的集合。任何值可以根据它的键进行检索。键是在映射唯一的，但值不一定是唯一的。</p>
<p>•映射也被称为哈希表。有两种类型的映射，不可变以及可变的。可变和不可变的对象之间的区别在于，当一个对象是不可变的，对象本身不能被改变。</p>
<p>•默认情况下，Scala中使用不可变的映射。如果想使用可变集，必须明确地导入scala.collection.mutable.Map类。但是可以通过生成新的映射来对原来的值进行改变。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> colors = <span class="type">Map</span>(<span class="string">"red"</span> -&gt; <span class="string">"#FF0000"</span>, <span class="string">"azure"</span> -&gt; <span class="string">"#F0FFFF"</span>)</span><br><span class="line"><span class="comment">//colors:scala.collection.immutable.Map[String,String]=Map(red-&gt;#FF0000,azure-&gt;#F0FFFF)</span></span><br></pre></td></tr></table></figure>

<p>基本操作：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>keys</td>
<td>返回 Map 所有的键(key)</td>
</tr>
<tr>
<td>values</td>
<td>返回 Map 所有的值(value)</td>
</tr>
<tr>
<td>isEmpty</td>
<td>在 Map 为空时返回true</td>
</tr>
</tbody></table>
<p>使用++运算符或Map.++()来连接两个map ,Map合并时会移除重复的Key</p>
<p><img src="/2021/01/06/scala/image-20210107152502957.png" alt="image-20210107152502957"></p>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2021/01/06/spark/">
      spark
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a class='author' href="/" rel="nofollow">
    <img no-lazy src="">
    <p>请设置文章作者</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Jan 6, 2021</p>
  </a>
</div>

            
          
            
              

            
          
            
              
  <div class="new-meta-item browse valine">
    <a class='notlink'>
      <i class="fas fa-eye fa-fw" aria-hidden="true"></i>
      
      <span id="/2021/01/06/spark/" class="leancloud_visitors" data-flag-title="spark">
      <p>
        <span class="leancloud-visitors-count"></span>
      </p>
      </span>
    </a>
  </div>


            
          
            
              
<div class="new-meta-item comments-count">
  
  <a href="/2021/01/06/spark/#comments">
    <i class="fas fa-comment-dots fa-fw"></i>
    <span class="valine-comment-count" data-xid="/2021/01/06/spark/">0</span>
    <span class="leancloud-comments-count">&nbsp;</span>
  </a>
</div>


            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="SPARK"><a href="#SPARK" class="headerlink" title="SPARK"></a>SPARK</h2><h3 id="1-为什么要用Spark"><a href="#1-为什么要用Spark" class="headerlink" title="1.为什么要用Spark"></a>1.为什么要用Spark</h3><ol>
<li><p>speed ：比Hadoop快100倍，比disk快十倍</p>
</li>
<li><p>Ease of use：比java,Scala,Python,R写程序块</p>
</li>
<li><p>Generality</p>
</li>
<li><p>Runs Everywhere:可跑在Hadoop，standalone等，可以接受包括HDFS，Cassandra,HBase等数据来源</p>
</li>
</ol>
<h3 id="2-与Hadoop差异"><a href="#2-与Hadoop差异" class="headerlink" title="2.与Hadoop差异"></a>2.与Hadoop差异</h3><ol>
<li>Spark把中间数据放在内存中，迭代运算效率高，MapReduce中计算结果需要存在磁盘上，影响整体速度。Spark支持DAG图分布式并行计算的编程框架，减少迭代过程数据落地</li>
<li>Spark容错性高：引进弹性分布式数据集RDD的抽象。它是分布在一组节点中的只读对象集合，这些集合是弹性的，如果数据集一部分丢失，则可以根据“血统”（即充许基于数据衍生过程）对它们进行重建。</li>
<li>Spark更加通用。不像Hadoop只提供了Map和Reduce两种操作，Spark提供的数据集操作类型有很多种，大致分为：Transformations和Actions两大类。Transformations包括Map、Filter、FlatMap、Sample、GroupByKey、ReduceByKey、Union、Join、Cogroup、MapValues、Sort和PartionBy等多种操作类型，同时还提供Count, Actions包括Collect、Reduce、Lookup和Save等操作。另外各个处理节点之间的通信模型不再像Hadoop只有Shuffle一种模式，用户可以命名、物化，控制中间结果的存储、分区等。</li>
</ol>
<h3 id="3-Spark体系结构与运行模式"><a href="#3-Spark体系结构与运行模式" class="headerlink" title="3.Spark体系结构与运行模式"></a>3.Spark体系结构与运行模式</h3><p><img src="/2021/01/06/spark/image-20210106130224820.png" alt="image-20210106130224820"></p>
<p><img src="/2021/01/06/spark/image-20210106130320155.png" alt="image-20210106130320155"></p>
<h3 id="4-RDD"><a href="#4-RDD" class="headerlink" title="4.RDD"></a>4.RDD</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>RDD是spark最基本的抽象，是对分布式内存的抽象使用。实现了以操作本地集合的方式来操作分布式数据集的抽象实现。RDD表示了已被分区，不可变的能够并行操作的数据集合，不同数据格式对应不同的RDD实现。RDD必须可序列化，可以cache到内存中，每次RDD的结果都放在内存中，下次可以直接从内存中输入，省去MapReduce的大量磁盘IO操作。对于迭代常见的机器学习和交互式数据挖掘效率提升很大。</p>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>来源：从持久存储获取或者从其他RDD生成</li>
<li>只读：状态不可变，不能修改</li>
<li>分区：支持元素根据key分区，保存到多个节点上</li>
<li>路径：RDD中叫世族或者血统，即RDD有充足的信息关于如何从其他RDD产生</li>
<li>持久化：控制存储级别来进行持久化</li>
<li>操作：丰富的动作：Count,Reduce,Collect,Save等</li>
</ul>
<h4 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h4><p><img src="/2021/01/06/spark/image-20210106164259353.png" alt="image-20210106164259353"></p>
<h4 id="例子：控制台日志挖掘"><a href="#例子：控制台日志挖掘" class="headerlink" title="例子：控制台日志挖掘"></a>例子：控制台日志挖掘</h4><p>假设网站中的一个 WebService 出现错误，我们想要从数以 TB 的 HDFS 日志文件中找到问题的原因，此时我们就可以用 Spark 加载日志文件到一组结点组成集群的 RAM 中，并交互式地进行查询。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lines = spark.textFile(<span class="string">"hdfs://..."</span>)</span><br></pre></td></tr></table></figure>

<p>这行从HDFS文件中创建出一个RDD</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errors = line.fliter(_.startWith(<span class="string">"Error"</span>))</span><br></pre></td></tr></table></figure>

<p>这行衍生出一个经过某种条件过滤的RDD（挑选出头为<code>Error</code>的值）</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">errors.persisit()</span><br></pre></td></tr></table></figure>

<p>这行将上一行出来的RDD errors缓存到内存中，但不会将第一个lines放到缓存中，因为文件可能比较大，缓存放不下，但是Error的集合比较小，缓存足以装进全部内存</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Count errors mentioning MySQL</span></span><br><span class="line">errors.filter(._contains(<span class="string">"MySQL"</span>)).count</span><br></pre></td></tr></table></figure>

<p>这行统计errors中包含MySQL 字样的总行数</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Return time fields of errors mentioning</span></span><br><span class="line"><span class="comment">//HDFS as an array (assuming time is field number 3 in a tab-separated format):</span></span><br><span class="line">errors.filter(._contains(<span class="string">"HDFS"</span>))</span><br><span class="line">	.map(._split('\t')(<span class="number">3</span>))</span><br><span class="line">	.collect()</span><br></pre></td></tr></table></figure>

<p>取出包含HDFS字样的行的第三列时间，并保存成一个集合</p>
<h4 id="RDD操作"><a href="#RDD操作" class="headerlink" title="RDD操作"></a>RDD操作</h4><p>RDD是Spark的核心抽象，所有计算都是围绕这RDD进行的</p>
<ul>
<li>转换：一个RDD经过计算后生成新的RDD，比如wordcount中的flatmap,map和ReduceByKey</li>
<li>动作：返回结果到Driver程序中，意味着RDD的计算结果，比如wordcount的collect操作</li>
</ul>
<p>转换是lazy模式，要等到有action操作时运行启动计算过程计算</p>
<p>action会返回结果或把RDD写到存储系统中，是触发Spark运算的动因</p>
<p><img src="/2021/01/06/spark/image-20210106195342838.png" alt="image-20210106195342838"></p>
<p><img src="/2021/01/06/spark/image-20210106195354883.png" alt="image-20210106195354883"></p>
<h4 id="传递函数参数"><a href="#传递函数参数" class="headerlink" title="传递函数参数"></a>传递函数参数</h4><p><img src="/2021/01/06/spark/image-20210106201542727.png" alt="image-20210106201542727"></p>
<p><img src="/2021/01/06/spark/image-20210106202040819.png" alt="image-20210106202040819"></p>
<h4 id="宽依赖和窄依赖"><a href="#宽依赖和窄依赖" class="headerlink" title="宽依赖和窄依赖"></a>宽依赖和窄依赖</h4><ul>
<li><p>窄依赖</p>
<ul>
<li>子RDD的每个分区依赖于常数个父分区（即与数据规模无关）</li>
<li>输入输出一对一的算子，且结果RDD的分区结构不变，主要是map,flatmap</li>
<li>输入输出一对一，但结果RDD的分区结构发生变化，如union,coalesce</li>
<li>从输入中选择部分元素的算子，如flater,distinct,subract,sample</li>
</ul>
</li>
<li><p>宽依赖</p>
<ul>
<li>子RDD的每个分区依赖于所有父分区</li>
<li>对单个RDD基于Key进行重组和reduce，如groupByKey,reduceByKey</li>
<li>对两个RDD基于Key进行join和重组，如join</li>
</ul>
</li>
</ul>
<h3 id="5-Shuffle"><a href="#5-Shuffle" class="headerlink" title="5.Shuffle"></a>5.Shuffle</h3><p>当一个RDD的一个分区依赖于前一个RDD的所有分区时，例如，对于单词Spark出现次数汇总时，该单词可能出现在所有分区中，需要将所有分区中Spark出现的键值汇总到某一数据节点进行汇总，这个过程叫做shuffle</p>
<h3 id="6-Spark内存管理"><a href="#6-Spark内存管理" class="headerlink" title="6.Spark内存管理"></a>6.Spark内存管理</h3><p>Spark 对堆内内存的管理是一种逻辑上的”规划式”的管理，因为对象实例占用内存的申请和释放都由 JVM 完成，Spark 只能在申请后和释放前<strong>记录</strong>这些内存，我们来看其具体流程：</p>
<p><strong>申请内存</strong>：</p>
<p>Spark 在代码中 new 一个对象实例</p>
<p>JVM 从堆内内存分配空间，创建对象并返回对象引用</p>
<p>Spark 保存该对象的引用，记录该对象占用的内存</p>
<p><strong>释放内存</strong>：</p>
<p>Spark 记录该对象释放的内存，删除该对象的引用</p>
<p>等待 JVM 的垃圾回收机制释放该对象占用的堆内内存</p>
<p><img src="/2021/01/06/spark/image-20210106212352334.png" alt="image-20210106212352334"></p>
<p>为了进一步优化内存的使用以及提高 Shuffle 时排序的效率，Spark 引入了堆外（Off-heap）内存，使之可以直接在工作节点的系统内存中开辟空间，存储经过序列化的二进制数据。利用 JDK Unsafe API（从 Spark 2.0 开始，在管理堆外的存储内存时不再基于 Tachyon，而是与堆外的执行内存一样，基于 JDK Unsafe API 实现[3]），Spark 可以直接操作系统堆外内存，减少了不必要的内存开销，以及频繁的 GC 扫描和回收，提升了处理性能。堆外内存可以被精确地申请和释放，而且序列化的数据占用的空间可以被精确计算，所以相比堆内内存来说降低了管理的难度，也降低了误差。</p>
<p>在默认情况下堆外内存并不启用，可通过配置 spark.memory.offHeap.enabled 参数启用，并由 spark.memory.offHeap.size 参数设定堆外空间的大小。除了没有 other 空间，堆外内存与堆内内存的划分方式相同，所有运行中的并发任务共享存储内存和执行内存。</p>
<p><img src="/2021/01/06/spark/image-20210106212503514.png" alt="image-20210106212503514"></p>
<h4 id="动态内存管理"><a href="#动态内存管理" class="headerlink" title="动态内存管理"></a>动态内存管理</h4><p><img src="/2021/01/06/spark/image-20210106212901176.png" alt="image-20210106212901176"></p>
<h4 id="存储内存管理"><a href="#存储内存管理" class="headerlink" title="存储内存管理"></a>存储内存管理</h4><h5 id="RDD的持久化机制："><a href="#RDD的持久化机制：" class="headerlink" title="RDD的持久化机制："></a>RDD的持久化机制：</h5><p>弹性分布式数据集（RDD）作为 Spark 最根本的数据抽象，是只读的分区记录（Partition）的集合，只能基于在稳定物理存储中的数据集上创建，或者在其他已有的 RDD 上执行转换（Transformation）操作产生一个新的 RDD。转换后的 RDD 与原始的 RDD 之间产生的依赖关系，构成了血统（Lineage）。凭借血统，Spark 保证了每一个 RDD 都可以被重新恢复。但 RDD 的所有转换都是惰性的，即只有当一个返回结果给 Driver 的行动（Action）发生时，Spark 才会创建任务读取 RDD，然后真正触发转换的执行。<br> Task 在启动之初读取一个分区时，会先判断这个分区是否已经被持久化，如果没有则需要检查 Checkpoint 或按照血统重新计算。所以如果一个 RDD 上要执行多次行动，可以在第一次行动中使用 persist 或 cache 方法，在内存或磁盘中持久化或缓存这个 RDD，从而在后面的行动时提升计算速度。事实上，cache 方法是使用默认的 MEMORY_ONLY 的存储级别将 RDD 持久化到内存，故缓存是一种特殊的持久化。 <strong>堆内和堆外存储内存的设计，便可以对缓存</strong> <strong>RDD</strong> <strong>时使用的内存做统一的规划和管 理</strong> （存储内存的其他应用场景，如缓存 broadcast 数据，暂时不在本文的讨论范围之内）。</p>
<p>RDD 的持久化由 Spark 的 Storage 模块 [7] 负责，实现了 RDD 与物理存储的解耦合。Storage 模块负责管理 Spark 在计算过程中产生的数据，将那些在内存或磁盘、在本地或远程存取数据的功能封装了起来。在具体实现时 Driver 端和 Executor 端的 Storage 模块构成了主从式的架构，即 Driver 端的 BlockManager 为 Master，Executor 端的 BlockManager 为 Slave。Storage 模块在逻辑上以 Block 为基本存储单位，RDD 的每个 Partition 经过处理后唯一对应一个 Block（BlockId 的格式为 rdd_RDD-ID_PARTITION-ID ）。Master 负责整个 Spark 应用程序的 Block 的元数据信息的管理和维护，而 Slave 需要将 Block 的更新等状态上报到 Master，同时接收 Master 的命令，例如新增或删除一个 RDD。</p>
<h4 id="RDD缓存过程"><a href="#RDD缓存过程" class="headerlink" title="RDD缓存过程"></a>RDD缓存过程</h4><p>在缓存到存储内存之前，partition中数据用Iterator访问。可以获取分区中没一体哦啊序列化或者非序列化的数据项，他们逻辑上占用JVM堆内的other部分空间，同一partition的不同Record空间并不连续</p>
<p>RDD 在缓存到存储内存之后，Partition 被转换成 Block，所有Record 在堆内或堆外存储内存中占用一块连续的空间。将Partition由不连续的存储空间转换为连续存储空间的过程，Spark称之为”展开”（Unroll）</p>
<p>因为不能保证存储空间可以一次容纳 Iterator 中的所有数据，当前的计算任务在 Unroll 时要向 MemoryManager 申请足够的 Unroll 空间来临时占位，空间不足则 Unroll 失败，空间足够时可以继续进行。对于序列化的 Partition，其所需的 Unroll 空间可以直接累加计算，一次申请。而非序列化的 Partition 则要在遍历 Record 的过程中依次申请，即每读取一条 Record，采样估算其所需的 Unroll 空间并进行申请，空间不足时可以中断，释放已占用的 Unroll 空间。如果最终 Unroll 成功，当前 Partition 所占用的 Unroll 空间被转换为正常的缓存 RDD 的存储空间</p>
<p><img src="/2021/01/06/spark/image-20210107104530406.png" alt="image-20210107104530406"></p>
<h4 id="淘汰和落盘"><a href="#淘汰和落盘" class="headerlink" title="淘汰和落盘"></a>淘汰和落盘</h4><p>存储内存的淘汰规则为：</p>
<p>被淘汰的旧 Block 要与新 Block 的 MemoryMode 相同，即同属于堆外或堆内内存</p>
<p>新旧 Block 不能属于同一个 RDD，避免循环淘汰</p>
<p>旧 Block 所属 RDD 不能处于被读状态，避免引发一致性问题</p>
<p>遍历 LinkedHashMap 中 Block，按照最近最少使用（LRU）的顺序淘汰，直到满足新 Block 所需的空间。其中 LRU 是 LinkedHashMap 的特性。</p>
<p>落盘的流程则比较简单，如果其存储级别符合_useDisk 为 true 的条件，再根据其_deserialized 判断是否是非序列化的形式，若是则对其进行序列化，最后将数据存储到磁盘，在 Storage 模块中更新其信息。</p>
<ul>
<li>由于同一个 Executor 的所有的计算任务共享有限的存储内存空间，当有新的 Block 需要缓存但是剩余空间不足且无法动态占用时，就要对 LinkedHashMap 中的旧 Block 进行淘汰（Eviction），而被淘汰的 Block 如果其存储级别中同时包含存储到磁盘的要求，则要对其进行落盘（Drop），否则直接删除该 Block。</li>
</ul>
<h4 id="执行内存管理"><a href="#执行内存管理" class="headerlink" title="执行内存管理"></a>执行内存管理</h4><p>Executor 内运行的任务同样共享执行内存，Spark 用一个 HashMap 结构保存了任务到内存耗费的映射。每个任务可占用的执行内存大小的范围为 1/2N ~ 1/N，其中 N 为当前 Executor 内正在运行的任务的个数。每个任务在启动之时，要向 MemoryManager 请求申请最少为 1/2N 的执行内存，如果不能被满足要求则该任务被阻塞，直到有其他任务释放了足够的执行内存，该任务才可以被唤醒</p>
<h4 id="shuffle内存占用"><a href="#shuffle内存占用" class="headerlink" title="shuffle内存占用"></a>shuffle内存占用</h4><p>在 ExternalSorter 和 Aggregator 中，Spark 会使用一种叫 AppendOnlyMap 的哈希表在堆内执行内存中存储数据，但在 Shuffle 过程中所有数据并不能都保存到该哈希表中，当这个哈希表占用的内存会进行周期性地采样估算，当其大到一定程度，无法再从 MemoryManager 申请到新的执行内存时，Spark 就会将其全部内容存储到磁盘文件中，这个过程被称为溢存(Spill)，溢存到磁盘的文件最后会被归并(Merge)。</p>
<p>Shuffle Write 阶段中用到的 Tungsten 是 Databricks 公司提出的对 Spark 优化内存和 CPU 使用的计划[9]，解决了一些 JVM 在性能上的限制和弊端。Spark 会根据 Shuffle 的情况来自动选择是否采用 Tungsten 排序。Tungsten 采用的页式内存管理机制建立在 MemoryManager 之上，即 Tungsten 对执行内存的使用进行了一步的抽象，这样在 Shuffle 过程中无需关心数据具体存储在堆内还是堆外。每个内存页用一个 MemoryBlock 来定义，并用 Object obj 和 long offset 这两个变量统一标识一个内存页在系统内存中的地址。堆内的 MemoryBlock 是以 long 型数组的形式分配的内存，其 obj 的值为是这个数组的对象引用，offset 是 long 型数组的在 JVM 中的初始偏移地址，两者配合使用可以定位这个数组在堆内的绝对地址；堆外的 MemoryBlock 是直接申请到的内存块，其 obj 为 null，offset 是这个内存块在系统内存中的 64 位绝对地址。Spark 用 MemoryBlock 巧妙地将堆内和堆外内存页统一抽象封装，并用页表(pageTable)管理每个 Task 申请到的内存页。</p>
<p>•执行内存主要用来存储任务在执行 Shuffle 时占用的内存，Shuffle 是按照一定规则对 RDD 数据重新分区的过程，我们来看 Shuffle 的 Write 和 Read 两阶段对执行内存的使用</p>
<p>•Shuffle Write：若在 map 端选择普通的排序方式，会采用 ExternalSorter 进行外排，在内存中存储数据时主要占用堆内执行空间。若在 map 端选择 Tungsten 的排序方式，则采用 ShuffleExternalSorter 直接对以序列化形式存储的数据排序，在内存中存储数据时可以占用堆外或堆内执行空间，取决于用户是否开启了堆外内存以及堆外执行内存是否足够。</p>
<p>•Shuffle Read：在对 reduce 端的数据进行聚合时，要将数据交给 Aggregator 处理，在内存中存储数据时占用堆内执行空间。如果需要进行最终结果排序，则要将再次将数据交给 ExternalSorter 处理，占用堆内执行空间。</p>
<h4 id="BlackManager在spark中扮演的角色"><a href="#BlackManager在spark中扮演的角色" class="headerlink" title="BlackManager在spark中扮演的角色"></a>BlackManager在spark中扮演的角色</h4><p>shuffle过程用到了BlackManager作为数据中转站</p>
<p>spark board cast调度task到多个executor的时候，broadcast底层使用的时数据存储层</p>
<p>如果我们对一个rdd进行cache，cacheManager也是把数据放在blockmanager中，截断了对计算链依赖，后续task运行的时候可以直接从cachemanager中获取到cacherdd，不用从头计算</p>
<h4 id="block和partition的关系"><a href="#block和partition的关系" class="headerlink" title="block和partition的关系"></a>block和partition的关系</h4><ul>
<li><p>RDD的运算基于partition每个task代表一个分区上的一个stage内的运算闭包，task被分别调度到多个executor上去运行，</p>
</li>
<li><p>如果 Block 在 BlockManager 中存在， 就会从 BlockManager 中获取，如果不存在， 就进行计算这个Block, 然后在 BlockManager 中进行存储持久化， 方便下次使用。</p>
</li>
<li><p>首先根据RDD id和partition index构造出block id (rdd_xx_xx)，接着从BlockManager中取出相应的block。</p>
<ul>
<li>如果该block存在，表示此RDD在之前已经被计算过和存储在BlockManager中，因此取出即可，无需再重新计算。</li>
<li>如果该block不存在则需要调用RDD的computeOrReadCheckpoint()函数计算出新的block，并将其存储到BlockManager中。</li>
</ul>
</li>
<li><p>需要注意的是block的计算和存储是阻塞的，若另一线程也需要用到此block则需等到该线程block的loading结束。</p>
</li>
<li><p>获取的时候是先从本地的 BlockManager 中获取， 如果本地没有， 然后再 从 remote 获取， 先从 driver 上获取到元数据 Block的位置， 然后去到真正的节点上fetch。</p>
</li>
<li><p>如果没有，就进行计算，然后根据存储级别，存储到计算节点本地的BlockManager 的内存或磁盘中，这样RDD的transformation、action就和block数据建立了联系，虽然抽象上我们的操作是在partition层面上进行的，但是partition最终还是被映射成为block，因此实际上我们的所有操作都是对block的处理和存取。</p>
</li>
</ul>
<h4 id="SparkCache过程总结"><a href="#SparkCache过程总结" class="headerlink" title="SparkCache过程总结"></a>SparkCache过程总结</h4><p>rdd 计算的时候， 首先根据RDD id和partition index构造出block id (rdd_xx_xx)， 接着从BlockManager中取出相应的block， 如果该block存在，表示此RDD在之前已经被计算过和存储在BlockManager中，因此取出即可，无需再重新计算。 如果 block 不存在我们可以 计算出来， 然后吧 block 通过 doPutIterator 函数存储在 节点上的 BlockManager上面， 汇报block信息到 driver, 下次如果使用同一个 rdd, 就可以直接从分布式存储中 直接取出相应的 block。</p>
<p><img src="/2021/01/06/spark/image-20210107134919314.png" alt="image-20210107134919314"></p>
<p><img src="/2021/01/06/spark/image-20210107134926188.png" alt="image-20210107134926188"></p>
<p><img src="/2021/01/06/spark/image-20210107134932364.png" alt="image-20210107134932364"></p>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2021/01/04/MapReduce/">
      MapReduce
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a class='author' href="/" rel="nofollow">
    <img no-lazy src="">
    <p>请设置文章作者</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Jan 4, 2021</p>
  </a>
</div>

            
          
            
              

            
          
            
              
  <div class="new-meta-item browse valine">
    <a class='notlink'>
      <i class="fas fa-eye fa-fw" aria-hidden="true"></i>
      
      <span id="/2021/01/04/MapReduce/" class="leancloud_visitors" data-flag-title="MapReduce">
      <p>
        <span class="leancloud-visitors-count"></span>
      </p>
      </span>
    </a>
  </div>


            
          
            
              
<div class="new-meta-item comments-count">
  
  <a href="/2021/01/04/MapReduce/#comments">
    <i class="fas fa-comment-dots fa-fw"></i>
    <span class="valine-comment-count" data-xid="/2021/01/04/MapReduce/">0</span>
    <span class="leancloud-comments-count">&nbsp;</span>
  </a>
</div>


            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="MapReduce原理及介绍"><a href="#MapReduce原理及介绍" class="headerlink" title="MapReduce原理及介绍"></a>MapReduce原理及介绍</h2><p>MapReduce是一个软件框架，可以支持大规模数据集上的并行和分布式运算。抽象了分布式计算系统上运行一个并行程序的数据流，以函数形式提供给用户两个接口：Map（映射）和Reduce（化简）用户可以重载这两个函数以实现交互和操纵其中的程序数据流</p>
<h4 id="MapReduce形式化定义"><a href="#MapReduce形式化定义" class="headerlink" title="MapReduce形式化定义"></a>MapReduce形式化定义</h4><p>MapReduce软件框架向用户提供了一个据欧数据流和控制流的抽象层，并隐藏了数据流的实现步骤。但抽象层提供了Map和Reduce两个函数，用户可以通过重载这两个主函数达到特定目标</p>
<p>用户首先重载Map和Reduce函数，然后调用<code>MapReduce（Spec，&amp;Results）</code>来开始数据流，其中<code>Spec</code>先在用户程序中初始化，然后用户编写代码来填入输入和输出文件名以及其他可选调节参数。这个对象还填入了Map和Reduce函数的名字，以识别这些用户定义的函数和MapReduce库里提供的函数</p>
<p><img src="/2021/01/04/MapReduce/image-20210105164548758.png" alt="image-20210105164548758"></p>
<h4 id="MapReduce逻辑数据流"><a href="#MapReduce逻辑数据流" class="headerlink" title="MapReduce逻辑数据流"></a>MapReduce逻辑数据流</h4><p>Map的输入数据是以<code>（key,value）</code>对形式出现，输出数据的结构类似于<code>（key,value）</code>对，称为中间<code>（key,value）</code>对，换句话说，用户自定义Map函数处理每个<code>（key,value）</code>对，并产生很多<code>（zero,one,ormore）</code>中间<code>（key,value）</code>对。目的是为了Map函数并行处理所有的<code>（key,value）</code>对</p>
<p><img src="/2021/01/04/MapReduce/image-20210105170548205.png" alt="image-20210105170548205"></p>
<p>反过来，Reduce函数以中间值群组的形式接受中间<code>（key,value）</code>对，这些中间值群组和一个中间key<code>（key,[set of values]）</code>相关。实际上，MapReduce框架形成了这些群组，先对中间<code>（key,value）</code>对排序，然后用key来对value分组</p>
<p><strong>注意，排序是为了简化分组</strong></p>
<p>reduce 函数处理每个<code>（key,[set of values]）</code>群组，并产生<code>（key,value）</code>对集合作为输出。</p>
<h4 id="单词计数顺序"><a href="#单词计数顺序" class="headerlink" title="单词计数顺序"></a>单词计数顺序</h4><p><img src="/2021/01/04/MapReduce/image-20210105191718304.png" alt="image-20210105191718304"></p>
<p><strong>符号化</strong>：（key1,val1）-Map函数-&gt;List(key2,val2)</p>
<p>​                （key2,List(val2)）-Reduce函数-&gt;List（val2）</p>
<h4 id="MapReduce真实数据和控制流"><a href="#MapReduce真实数据和控制流" class="headerlink" title="MapReduce真实数据和控制流"></a>MapReduce真实数据和控制流</h4><p>1.数据分区：MapReduce库将已存入GFS的输入数据分割成m份，M也即映射任务的数量。</p>
<p>2.计算分区：计算模块强迫用户以Map和Reduce函数的形式编写程序，并在框架中隐式处理，所以MapReduce库只生成用户程序的多个复制（fork），包含MAp和Reduce函数，然后在多个可用的计算引擎上分配。</p>
<p>3.决定主服务器（master）和服务器（worker）：MapReduce基于主服务器-服务器模式，一个用户程序的复制变为主服务器，其余是服务器。主服务器挑选空闲服务器，分配MapReduce任务给他们。</p>
<p>4.读取输入数据（数据分发）：每一个映射服务器读取其输入数据的相应部分，即输入数据分割，然后输入至其Map函数。虽然一个映射服务器可能运行多个Map函数，这意味着它分到了不止一个输入数据分割；通常每个服务器只分到一个输入分割。</p>
<p>5.Map函数：用<code>（key,value）</code>对集合的形式收到输入数据分割，来处理并产生中间<code>（key,value）</code>对。</p>
<p>6.Combiner函数：映射服务器中一个可选的本地函数。适用于中间的<code>（key,value）</code>对。用户可以在用户程序里调用。Combiner运行与Reduce一样的功能。合并每个映射服务器的本地数据然后送到网络传输。</p>
<p>7.Partitioning函数：分块是由Partitioning（分区）函数完成，并能保证有相同键值的所有<code>（key,value）</code>对都能存储在同一区域内。因此，由于化简服务器i读取所有映射服务器区域i中的数据，有相同key的所有<code>（key,value）</code>对将由相应的化简服务器i收集。 </p>
<p><img src="/2021/01/04/MapReduce/image-20210105201025104.png" alt="image-20210105201025104"></p>
<p>8.同步：当所有映射任务完成，他们之间的通信开始</p>
<p>9.通信：Reduce服务器i已经知道所有映射服务器的区域i的位置，使用远程过程调用来从所有映射服务器的各个区域中读取数据。由于所有化简服务器从所有映射服务器中读取数据，映射和化简服务器之间的多对多通信在网络中进行，会引发网络拥塞。这个问题是提高此类系统性能的一个主要瓶颈。</p>
<p>10.排序和分组：当化简服务器完成读取输入数据的过程时，数据首先在化简服务器的本地磁盘中缓冲。然后化简服务器根据key将数据排序来对中间(key, value)对进行分组，之后对出现的所有相同key进行分组。注意，缓冲数据已经排序并分组，因为一个映射服务器产生的唯一key的数量可能会多于R个区域，所以在每个映射服务器区域中可能有不止一个key。</p>
<p>11.Reduce函数：简化服务器在已分组的<code>（key,value）</code>对上的迭代。对于每一个唯一的key，把key对应的value发送给Reduce函数，然后把这个函数出来输入数据，最后的结果存入用户程序指定的文件中。</p>
<p><img src="/2021/01/04/MapReduce/image-20210105205303260.png" alt="image-20210105205303260"></p>
<h4 id="来自Apache的Hadoop软件库"><a href="#来自Apache的Hadoop软件库" class="headerlink" title="来自Apache的Hadoop软件库"></a>来自Apache的Hadoop软件库</h4><p>Hadoop是Apache用Java实现的MapReduce开源实现，使用HDFS作为底层，MapReduce引擎是运行在HDFS上的计算引擎，HDFS是他的数据存储管理器。</p>
<p>HDFS：源于GFS的分布式文件系统，分布式计算系统上管理文件和存储数据</p>
<p><img src="/2021/01/04/MapReduce/image-20210106100205802.png" alt="image-20210106100205802"></p>
<p>HDFS体系结构：主从体系结构，包括单个NameNode(master)和多个DataNode(slave)。HDFS将文件分为固定大小的块，并存放在工作机中，块的映射由Namenode决定。master也管理文件系统的元数据和命名空间，在系统中，命名空间是维护元数据的区域，元数据是指一个文件系统存储的所有信息。是所有文件的全面管理所需要的。</p>
<p><img src="/2021/01/04/MapReduce/image-20210106103330168.png" alt="image-20210106103330168"></p>
<p>HDFS特性：HDFS不支持安全性，主要讨论两个特性</p>
<ul>
<li><p>容错能力：Hadoop设计时默认部署在廉价的硬件上，系统故障很常见。</p>
<ul>
<li>块复制：HDFS把文件存储为一个块集，每个块都有备份并且在整个集群上分发。</li>
<li>备份布置：提供更大的可靠性，但通信成本稍高</li>
<li>HeartBeat和LockReport消息：这两个消息都由DataNode传输给NameNode，收到Heartbeat意味着DataNode正常运行，而每个Blockreport包括DataNode上所有块的清单</li>
</ul>
</li>
<li><p>高吞吐量访问大规模数据集：因为是为批处理设计而非交互式处理，所以吞吐量比延时更重要。</p>
</li>
</ul>
<p>HDFS操作：控制流能正确突出在管理操作中NameNode和DataNode的角色</p>
<ul>
<li>读取文件：用户发送Open请求给NameNode来获取文件块位置信息</li>
<li>写入文件：用户发送create请求给NameNode来在命名空间里创建文件</li>
</ul>
<h4 id="Hadoop里运行作业"><a href="#Hadoop里运行作业" class="headerlink" title="Hadoop里运行作业"></a>Hadoop里运行作业</h4><p><img src="/2021/01/04/MapReduce/image-20210105214423025.png" alt="image-20210105214423025"></p>
<ul>
<li><p>作业提交：每个作业由用户提交到master</p>
<ul>
<li>用户从master请求新ID，并计算输入文件分块</li>
<li>用户复制资源l比如用户的JAR文件、配置文件和计算输入分块，至JobTracker文件系统。</li>
<li>用户节点通过调用submitJob()函数提交任务至JobTracker。</li>
</ul>
</li>
<li><p>任务分配：JobTracker为用户节点的每个计算输入块建立一个映射任务，并分配给TaskTracker的执行槽。当分配映射任务给TaskTracker时，JobTracker会考虑数据的定位。JobTracker也会创建化简任务，并分配给TaskTracker。 </p>
</li>
<li><p>任务执行：把作业JAR文件复制到其文件系统之后，在TaskTracker执行一个任务（不管映射还是化简）的控制流就开始了。在启动Java虚拟机（Java Virtual Machine，JVM）来运行它的映射或化简任务后，就开始执行作业JAR文件里的指令。</p>
</li>
<li><p>任务运行校验：通过接收从TaskTracker到JobTracker的周期性心跳监听消息来完成任务运行校验。每个心跳监听会告知JobTracker传送中的TaskTracker是可用的，以及传送中的TaskTracker是否准备好运行一个新的任务。 </p>
</li>
</ul>
<p><img src="/2021/01/04/MapReduce/image-20210106104041624.png" alt="image-20210106104041624"></p>
<p><img src="/2021/01/04/MapReduce/image-20210106104054859.png" alt="image-20210106104054859"></p>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box shadow reveal ">
  


  <section class='meta'>
    
      
      
      <div class="meta" id="header-meta">
        
          
  <h2 class="title">
    <a href="/2021/01/03/Distributed-cloud-computing/">
      Distributed_cloud-computing
    </a>
  </h2>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a class='author' href="/" rel="nofollow">
    <img no-lazy src="">
    <p>请设置文章作者</p>
  </a>
</div>

            
          
            
              

            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：Jan 3, 2021</p>
  </a>
</div>

            
          
            
              

            
          
            
              
  <div class="new-meta-item browse valine">
    <a class='notlink'>
      <i class="fas fa-eye fa-fw" aria-hidden="true"></i>
      
      <span id="/2021/01/03/Distributed-cloud-computing/" class="leancloud_visitors" data-flag-title="Distributed_cloud-computing">
      <p>
        <span class="leancloud-visitors-count"></span>
      </p>
      </span>
    </a>
  </div>


            
          
            
              
<div class="new-meta-item comments-count">
  
  <a href="/2021/01/03/Distributed-cloud-computing/#comments">
    <i class="fas fa-comment-dots fa-fw"></i>
    <span class="valine-comment-count" data-xid="/2021/01/03/Distributed-cloud-computing/">0</span>
    <span class="leancloud-comments-count">&nbsp;</span>
  </a>
</div>


            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="第一章-分布式系统模型和关键技术"><a href="#第一章-分布式系统模型和关键技术" class="headerlink" title="第一章 分布式系统模型和关键技术"></a>第一章 分布式系统模型和关键技术</h2><h3 id="1-1互联网上的可扩展计算"><a href="#1-1互联网上的可扩展计算" class="headerlink" title="1.1互联网上的可扩展计算"></a>1.1互联网上的可扩展计算</h3><p>一个并行的、分布式的计算系统使用大量的计算机解决互联网上的大规模计算问题。<br>   分布式计算的缺点是数据敏感和网络中心化</p>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210103101834253.png" alt="image-20210103101834253"></p>
<h3 id="计算范式之间区别"><a href="#计算范式之间区别" class="headerlink" title="计算范式之间区别"></a>计算范式之间区别</h3><p>集中式计算：计算资源存储在一个物理系统内，所有资源共享，紧耦合在一个集成式操作系统中</p>
<p>并行计算：所有处理器紧耦合于中心共享内存或松耦合于分布式内存</p>
<p>分布式计算：众多自治的计算机组成，拥有私有内存，通过计算机网络通信。信息交换通过消息传递完成。</p>
<p>云计算：集中式或分布式，由物理的或虚拟的计算资源构建</p>
<p>普适计算：任何地点时间通过有线或者无线用普遍设备计算</p>
<p>物联网：通过互联网云实现普适计算</p>
<h3 id="分布式和云计算系统模型"><a href="#分布式和云计算系统模型" class="headerlink" title="分布式和云计算系统模型"></a>分布式和云计算系统模型</h3><p><img src="/2021/01/03/Distributed-cloud-computing/image-20210103104520742.png" alt="image-20210103104520742"></p>
<h3 id="协同计算机集群"><a href="#协同计算机集群" class="headerlink" title="协同计算机集群"></a>协同计算机集群</h3><p><img src="/2021/01/03/Distributed-cloud-computing/image-20210103104933760.png" alt="image-20210103104933760"></p>
<h3 id="互联网云计算"><a href="#互联网云计算" class="headerlink" title="互联网云计算"></a>互联网云计算</h3><p>云提供了虚拟机或物理机快速配置和划分，云支持冗余，自恢复，高可扩展编程模型，允许负载从许多不可避免的硬件软件错误中恢复。最终云计算系统可以通过实时监视资源来确保分配在需要时平衡</p>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210103105242598.png" alt="image-20210103105242598"></p>
<h3 id="性能、安全和节能"><a href="#性能、安全和节能" class="headerlink" title="性能、安全和节能"></a>性能、安全和节能</h3><h4 id="性能度量"><a href="#性能度量" class="headerlink" title="性能度量"></a>性能度量</h4><ul>
<li>性能度量（MIPS、Tflops）每秒浮点运算次数（M/T）、（TPS）每秒事物数，其他度量包括作业响应时间和网络延迟</li>
<li>系统开销归因于系统启动时间、编译时间、IO数据速率和运行时支持系统消耗。其他性能包括互联网WEb QoS，系统可用性和可靠性，抵抗网络攻击的安全弹性</li>
</ul>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210103105756172.png" alt="image-20210103105756172"></p>
<h2 id="第三章-虚拟机集群和数据中心虚拟化"><a href="#第三章-虚拟机集群和数据中心虚拟化" class="headerlink" title="第三章 虚拟机集群和数据中心虚拟化"></a>第三章 虚拟机集群和数据中心虚拟化</h2><h3 id="3-1-虚拟化的实现层次"><a href="#3-1-虚拟化的实现层次" class="headerlink" title="3.1 虚拟化的实现层次"></a>3.1 虚拟化的实现层次</h3><p>通过在一个硬件主机上多路复用的虚拟机方式共享昂贵的硬件资源</p>
<p>基本思想是分离软硬件以产生更好的系统性能</p>
<h4 id="虚拟化实现层次"><a href="#虚拟化实现层次" class="headerlink" title="虚拟化实现层次"></a>虚拟化实现层次</h4><p>为了让客户操作系统独立于主机操作系统并同时运行在一个硬件上，添加虚拟化层软件完成（hypercisor）/虚拟机监视器（VMM）</p>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210103111007166.png" alt="image-20210103111007166"></p>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210103111806694.png" alt="image-20210103111806694"></p>
<ul>
<li><p>指令集体系结构级：代码解释和动态二进制翻译</p>
</li>
<li><p>硬件抽象级：虚拟化一个计算机硬件资源</p>
</li>
<li><p>操作系统级：在单一物理服务器上创建隔离的容器和操作系统实例</p>
</li>
<li><p>库支持级：库接口的虚拟化</p>
</li>
<li><p>应用程序级：进程级虚拟化、高级语言（High Level Language，HLL）虚拟机</p>
</li>
</ul>
<h4 id="VMM设计需求"><a href="#VMM设计需求" class="headerlink" title="VMM设计需求"></a>VMM设计需求</h4><h5 id="需求："><a href="#需求：" class="headerlink" title="需求："></a>需求：</h5><ul>
<li><p>为程序提供与原始硬件机器一致的环境</p>
</li>
<li><p>运行在环境中的程序性能损失较低</p>
</li>
<li><p>系统资源处在完全控制中</p>
</li>
</ul>
<h5 id="资源："><a href="#资源：" class="headerlink" title="资源："></a>资源：</h5><ul>
<li>为应用程序分配硬件</li>
<li>程序不能访问任何未分配给他的资源</li>
<li>某些情况下VMM可以获得对已分配资源的控制权</li>
</ul>
<h4 id="操作系统级虚拟化"><a href="#操作系统级虚拟化" class="headerlink" title="操作系统级虚拟化"></a>操作系统级虚拟化</h4><p>操作系统中插入一个虚拟化层，使得操作系统内核中同时运行多个隔离虚拟机，这种虚拟机也称（VE、VPS、容器）</p>
<p>用户看来VE就是真实服务器，有自己进程，文件系统，用户账号，带IP的网络接口，路由表，防火墙规则和其他个人设置，</p>
<p>不同用户共享一个系统内核，<strong>操作系统虚拟化也称系统镜像虚拟化</strong></p>
<h3 id="3-2虚拟化的结构、工具与机制"><a href="#3-2虚拟化的结构、工具与机制" class="headerlink" title="3.2虚拟化的结构、工具与机制"></a>3.2虚拟化的结构、工具与机制</h3><p>hypervisor与Xen体系结构</p>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210103131438789.png" alt="image-20210103131438789"></p>
<ul>
<li>Xen属于微内核hypersor</li>
<li>提供一种客户端直接访问物理设备的机制</li>
<li>提供处于硬件和操作系统之间的虚拟环境</li>
<li>核心组件是hypercisor、内核和应用程序</li>
<li>具有控制特权的客户操作系统称为Doman0，其他称为DomanU</li>
<li>Doman0首先启动，直接访问硬件和设备，为所有DomanU分配资源</li>
</ul>
<h4 id="全虚拟化的二进制翻译"><a href="#全虚拟化的二进制翻译" class="headerlink" title="全虚拟化的二进制翻译"></a>全虚拟化的二进制翻译</h4><p>全虚拟化（依赖二进制翻译，客户端和应用由非临界和临界指令生成）</p>
<p>基于主机的虚拟化（操作系统和客户机同时存在，虚拟化软件层位于两者之间，客户端跑在虚拟化层上，特定的应用运行在虚拟机中）</p>
<h4 id="编译器支持的半虚拟化技术"><a href="#编译器支持的半虚拟化技术" class="headerlink" title="编译器支持的半虚拟化技术"></a>编译器支持的半虚拟化技术</h4><p><img src="/2021/01/03/Distributed-cloud-computing/image-20210103141520694.png" alt="image-20210103141520694"></p>
<h3 id="3-3CPU、内存和IO设备的虚拟化"><a href="#3-3CPU、内存和IO设备的虚拟化" class="headerlink" title="3.3CPU、内存和IO设备的虚拟化"></a>3.3CPU、内存和IO设备的虚拟化</h3><h4 id="虚拟化的硬件支持"><a href="#虚拟化的硬件支持" class="headerlink" title="虚拟化的硬件支持"></a>虚拟化的硬件支持</h4><p>为防止系统崩溃，设置用户模式和管理模式，对临界区硬件的受控访问（特权指令和非特权指令）</p>
<h4 id="CPU虚拟化"><a href="#CPU虚拟化" class="headerlink" title="CPU虚拟化"></a>CPU虚拟化</h4><ul>
<li><p>非特权指令直接在物理主机运行</p>
</li>
<li><p>关键指令</p>
<ul>
<li>特权指令在特权模式执行，非特权模式发生<strong>陷入</strong></li>
<li>控制敏感指令尝试改变资源配置</li>
<li>行为敏感指令根据资源配置有不同行为，包括虚拟内存的负载和存储</li>
</ul>
</li>
<li><p>VMM在运行管理模式时，CPU支持在用户模式运行虚拟机的特权指令和非特权指令，则CPU体系结构是可虚拟化的</p>
</li>
<li><p>RISC的所有控制敏感和行为敏感指令都是特权指令，所以RISC的CPU是天然可虚拟化的</p>
</li>
</ul>
<h4 id="内存虚拟化"><a href="#内存虚拟化" class="headerlink" title="内存虚拟化"></a>内存虚拟化</h4><p>多级页表，虚拟内存</p>
<h4 id="I-O虚拟化"><a href="#I-O虚拟化" class="headerlink" title="I/O虚拟化"></a>I/O虚拟化</h4><ul>
<li>全设备模拟：一个设备的所有功能和总线结构都在软件中复制</li>
<li>半虚拟化：Xen使用的方法，分为前端后端，前端在DomainU中，后端在Domain0中，通过一块共享内存交互</li>
<li>直接IO虚拟化：虚拟机直接访问设备硬件获得近乎本地性能，CPU开销不高</li>
</ul>
<h4 id="多核处理器虚拟化"><a href="#多核处理器虚拟化" class="headerlink" title="多核处理器虚拟化"></a>多核处理器虚拟化</h4><p>困难</p>
<ul>
<li>编程者必须完全并行使用所有处理器核</li>
<li>软件明确的为处理器分配任务</li>
</ul>
<p>使用三级的Cache进行层次缓冲</p>
<h3 id="3-4-虚拟集群与资源管理"><a href="#3-4-虚拟集群与资源管理" class="headerlink" title="3.4 虚拟集群与资源管理"></a>3.4 虚拟集群与资源管理</h3><h4 id="物理集群与虚拟集群"><a href="#物理集群与虚拟集群" class="headerlink" title="物理集群与虚拟集群"></a>物理集群与虚拟集群</h4><p>虚拟集群：多个客户虚拟机，安装在由一个或多个物理集群构成的分布式服务器上，逻辑上跨越物理网络的虚拟网络互联，为虚拟集群提供虚拟机的过程可以动态运行</p>
<ul>
<li>虚拟集群节点可以是物理机器或者虚拟机器</li>
<li>主机操作系统管理物理机器资源，虚拟机运行其上，可以运行与主机相异的操作系统</li>
<li>虚拟机的目的是合并同一台物理服务器的多个功能</li>
<li>虚拟机可以在多个物理服务器上备份，提高分布式并行度，容错性，加快灾难恢复速度</li>
<li>节点数可以动态删减（与P2P类似）</li>
<li>物理节点失效会使运行在其上的虚拟机失效，但是虚拟机失效不会影响主机系统</li>
</ul>
<h4 id="快速-部署和有效调度"><a href="#快速-部署和有效调度" class="headerlink" title="快速 部署和有效调度"></a>快速 部署和有效调度</h4><h5 id="快速部署："><a href="#快速部署：" class="headerlink" title="快速部署："></a>快速部署：</h5><ul>
<li><p>集群内的物理节点尽快构建发布软件栈，</p>
</li>
<li><p>运行时环境可以从一个用户虚拟集群快速切换到另一个用户虚拟集群</p>
</li>
</ul>
<p>虚拟化另一个优点：负载均衡（通过负载指数和用户登录频率等指标完成）</p>
<h4 id="高性能虚拟存储"><a href="#高性能虚拟存储" class="headerlink" title="高性能虚拟存储"></a>高性能虚拟存储</h4><p>用于减少虚拟集群分布式文件中的复制块</p>
<h4 id="在线迁移虚拟机的步骤与性能影响"><a href="#在线迁移虚拟机的步骤与性能影响" class="headerlink" title="在线迁移虚拟机的步骤与性能影响"></a>在线迁移虚拟机的步骤与性能影响</h4><p>虚拟集群中的虚拟机客户系统与主机系统并存，当一个虚拟机失效时，其角色可被其他节点上虚拟机替代，只要两个虚拟机运行相同的客户端系统</p>
<p>一个物理节点故障转移至另一个主机的虚拟机上</p>
<h4 id="管理虚拟集群的四种方式"><a href="#管理虚拟集群的四种方式" class="headerlink" title="管理虚拟集群的四种方式"></a>管理虚拟集群的四种方式</h4><ul>
<li>基于客户的管理器 集群管理器在客户系统中，多个虚拟机形成一个虚拟集群</li>
<li>基于主机的集群管理器，监督客户系统并能在另一物理量机器上重启客户系统</li>
<li>在主机系统和客户系统中使用相同独立的集群管理器（基础设施复杂）</li>
<li>主机系统和客户系统中使用集成的集群：管理器能区分虚拟资源和物理资源</li>
</ul>
<h4 id="虚拟机迁移"><a href="#虚拟机迁移" class="headerlink" title="虚拟机迁移"></a>虚拟机迁移</h4><p><img src="/2021/01/03/Distributed-cloud-computing/image-20210103152653011.png" alt="image-20210103152653011"></p>
<h4 id="内存、文件与网络资源迁移"><a href="#内存、文件与网络资源迁移" class="headerlink" title="内存、文件与网络资源迁移"></a>内存、文件与网络资源迁移</h4><p>内存迁移：将虚拟机的内存实例从一个物理节点迁到另一个物理节点</p>
<p>文件系统迁移：为每个虚拟机提供一个一致的位置无关的在所有物理主机上都能访问的文件系统</p>
<p>网络迁移：迁移时虚拟机应维持所有开放的网络连接，不依赖原始主机转发或者依赖移动性或重定向机制的支持</p>
<p>在线迁移主要使用预复制方法：先传输所有的内存页，然后迭代传输上次传输中被修改的内存页</p>
<h3 id="3-5-数据中心的自动化与虚拟化"><a href="#3-5-数据中心的自动化与虚拟化" class="headerlink" title="3.5 数据中心的自动化与虚拟化"></a>3.5 数据中心的自动化与虚拟化</h3><h4 id="数据中心服务器合并"><a href="#数据中心服务器合并" class="headerlink" title="数据中心服务器合并"></a>数据中心服务器合并</h4><p>减少服务器数目，改进硬件资源低利用效率</p>
<p>数据中心需要优化资源管理，这些服务器合并技术在整机服务器运行，难以使资源管理得到有效优化</p>
<ul>
<li>合并增强硬件利用效率</li>
<li>资源得到更灵活的配置调度</li>
<li>总体拥有成本降低</li>
<li>改进可用性和业务连续性</li>
</ul>
<h4 id="虚拟存储管理"><a href="#虚拟存储管理" class="headerlink" title="虚拟存储管理"></a>虚拟存储管理</h4><p>虚拟存储包括由VMM和客户操作系统管理的存储</p>
<p>分为虚拟机镜像和应用程序数据</p>
<p>最重要的是封装和隔离：一个虚拟机仅运行一个系统，系统中运行许多应用程序，系统虚拟化允许许多虚拟机同时运行在物理机器上并且虚拟机之间完全隔离。</p>
<h4 id="虚拟化数据中心的可信管理"><a href="#虚拟化数据中心的可信管理" class="headerlink" title="虚拟化数据中心的可信管理"></a>虚拟化数据中心的可信管理</h4><p>VMM是虚拟系统安全基础，虚拟机访问任何硬件都需要VMM的审查</p>
<h2 id="第四章：构建在虚拟化数据中心上的云平台体系结构"><a href="#第四章：构建在虚拟化数据中心上的云平台体系结构" class="headerlink" title="第四章：构建在虚拟化数据中心上的云平台体系结构"></a>第四章：构建在虚拟化数据中心上的云平台体系结构</h2><h3 id="4-1-云计算和服务模型"><a href="#4-1-云计算和服务模型" class="headerlink" title="4.1 云计算和服务模型"></a>4.1 云计算和服务模型</h3><ul>
<li>任意位置访问部署（便宜）</li>
<li>构建在大规模数据中心之上</li>
<li>致力于自动化的硬件、数据库、用户接口和应用程序环境吧他们结构化为虚拟资源，来驱动下一代的数据中心</li>
<li>渴望通过自动化资源配置来构建更好的数据中心</li>
</ul>
<p>云计算是一种高吞吐量的计算范式，通过大的数据中心或服务器群提供服务。使得用户可以随时随地通过狐狸啊设备访问共享资源</p>
<h4 id="公有云和私有云"><a href="#公有云和私有云" class="headerlink" title="公有云和私有云"></a>公有云和私有云</h4><p><img src="/2021/01/03/Distributed-cloud-computing/image-20210103162023316.png" alt="image-20210103162023316"></p>
<h4 id="云设计目标"><a href="#云设计目标" class="headerlink" title="云设计目标"></a>云设计目标</h4><ul>
<li><p>将计算从桌面转向数据中心，计算中心</p>
</li>
<li><p>服务配置与云效益</p>
</li>
<li><p>性能可扩展</p>
</li>
<li><p>数据隐私保护</p>
</li>
<li><p>高质量云服务</p>
</li>
<li><p>新标准和接口</p>
</li>
<li><p>降低小型用户大型企业计算成本</p>
</li>
<li><p>减轻创业型公司经济负担</p>
</li>
</ul>
<h4 id="基础设施及服务（IaaS）"><a href="#基础设施及服务（IaaS）" class="headerlink" title="基础设施及服务（IaaS）"></a>基础设施及服务（IaaS）</h4><p>云计算将基础设施，平台和软件作为服务发布，是的用户能够即用即付，使用基于订阅的服务。</p>
<p>云上服务分为三种：IaaS,Paas(平台即服务),SaaS（软件即服务）</p>
<p>SaaS由用户使用特殊接口，在应用程序端，PaaS层，云平台进行计费服务，处理作业队列，启动监视服务。底层是IaaS服务，需要配置数据库，计算实例，文件系统和存储以满足用户需求。IaaS包括存储即服务，计算实例即服务和通信即服务</p>
<h4 id="平台即服务（PaaS）"><a href="#平台即服务（PaaS）" class="headerlink" title="平台即服务（PaaS）"></a>平台即服务（PaaS）</h4><p>平台云是一个由硬件和软件基础设施构成的集成的计算机系统，可以在这个虚拟化云平台使用提供商支持的一些编程语言和软件工具开发用户应用程序</p>
<p>用户不需要管理底层基础设施，世界不同的用户可以在统一的软件平台协同工作，鼓励第三方组织提供软件管理，集成和服务监视解决方案。</p>
<h4 id="软件即服务（SaaS）"><a href="#软件即服务（SaaS）" class="headerlink" title="软件即服务（SaaS）"></a>软件即服务（SaaS）</h4><p>软件即服务是指上千的云客户通过浏览器访问的应用程序软件</p>
<p>PaaS 提供的服务和工具用于构建应用程序和管理他们所部署的由IaaS提供的资源</p>
<p>SaaS模型将软件应用作为服务进行提供，对客户来讲，无需为服务器或软件预先投资，对提供商来讲，与传统的用户应用程序托管相比成本很低</p>
<p>为支持PaaS和IaaS，客户数据存储在云中，云或者是专门的提供商，或者公开托管</p>
<h3 id="4-2-数据中心设计与互联网络"><a href="#4-2-数据中心设计与互联网络" class="headerlink" title="4.2 数据中心设计与互联网络"></a>4.2 数据中心设计与互联网络</h3><p>数据中心是大量服务器通过巨大互联网构建而成</p>
<p>数据中心越大，运营成本越低</p>
<p>数据中心关键的核心设计师数据中心集群中所有服务器之间的互联网络，要求低延迟，高带宽，低成本，消息传递接口，通信支持和容错，必须满足服务器节点之间点对点和群对群通信模式</p>
<ul>
<li>应用程序的网络通信支持</li>
<li>网络可扩展性</li>
<li>容错与降级</li>
<li>以交换机为中心的数据中心设计</li>
</ul>
<h4 id="数据中心管理问题"><a href="#数据中心管理问题" class="headerlink" title="数据中心管理问题"></a>数据中心管理问题</h4><ul>
<li>使普通用户满意</li>
<li>可控信息流</li>
<li>多用户管理</li>
<li>适应数据库增长可扩展性</li>
<li>用户和提供商低成本</li>
<li>安全防范和数据保护</li>
<li>绿色信息技术</li>
</ul>
<h3 id="4-3-计算与存储云体系结构设计"><a href="#4-3-计算与存储云体系结构设计" class="headerlink" title="4.3 计算与存储云体系结构设计"></a>4.3 计算与存储云体系结构设计</h3><h4 id="通用云体系结构设计"><a href="#通用云体系结构设计" class="headerlink" title="通用云体系结构设计"></a>通用云体系结构设计</h4><p>云设计目标：可扩展性，虚拟化，有效性，可靠性</p>
<p>云管理器软件要同时支持物理机和虚拟机，共享资源的安全性和数据中心的共享访问为设计提出另一个挑战</p>
<h4 id="云的关键技术"><a href="#云的关键技术" class="headerlink" title="云的关键技术"></a>云的关键技术</h4><p><img src="/2021/01/03/Distributed-cloud-computing/image-20210104105513118.png" alt="image-20210104105513118"></p>
<h4 id="通用云体系结构"><a href="#通用云体系结构" class="headerlink" title="通用云体系结构"></a>通用云体系结构</h4><p><img src="/2021/01/03/Distributed-cloud-computing/image-20210104105602739.png" alt="image-20210104105602739"></p>
<h4 id="层次化云体系结构开发"><a href="#层次化云体系结构开发" class="headerlink" title="层次化云体系结构开发"></a>层次化云体系结构开发</h4><p>三层：基础设施层，平台层，应用程序层，<strong>使用云中分配的经虚拟化和标准化的硬件与软件资源实现</strong></p>
<p>首先部署基础设施层来支持IaaS服务。基础设施层是为支持PaaS服务构建云平台层的基础。平台层是为SaaS应用而实现应用层的基础。</p>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210104105813088.png" alt="image-20210104105813088"></p>
<h4 id="虚拟化支持和灾难恢复"><a href="#虚拟化支持和灾难恢复" class="headerlink" title="虚拟化支持和灾难恢复"></a>虚拟化支持和灾难恢复</h4><p>云计算的虚拟化意味着资源和基础设施都是虚拟化的。</p>
<p>虚拟化软件用来虚拟化硬件。系统虚拟化软件是一种特殊类型的软件，它模拟硬件的执行并在其上运行未经修改的操作系统。云计算系统使用虚拟化软件作为遗产软件（如旧操作系统或罕见应用）的运行环境。虚拟化软件也被用作开发新的云应用的平台</p>
<p>  系统虚拟化软件可被看做是一种硬件模拟机制，可以在系统虚拟化软件上不经修改地直接运行之前运行在裸机上的操作系统。</p>
<h4 id="体系结构设计挑战"><a href="#体系结构设计挑战" class="headerlink" title="体系结构设计挑战"></a>体系结构设计挑战</h4><p>挑战1：服务可用性和数据锁定问题</p>
<p>挑战2：数据隐私和安全性考虑</p>
<p>挑战3：不可预测的性能和瓶颈</p>
<p>挑战4：分布式存储和广泛存在的软件故障</p>
<p>挑战5：云可扩展性、互操作性和标准化</p>
<p>挑战6：软件许可和信誉共享</p>
<h2 id="第五章-面向服务的分布式体系结构"><a href="#第五章-面向服务的分布式体系结构" class="headerlink" title="第五章 面向服务的分布式体系结构"></a>第五章 面向服务的分布式体系结构</h2><h4 id="服务和面向服务体系结构"><a href="#服务和面向服务体系结构" class="headerlink" title="服务和面向服务体系结构"></a>服务和面向服务体系结构</h4><p>SOA是一种分布式系统体系结构，旨在如何设计一套使用的服务的软件系统，</p>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210104113827935.png" alt="image-20210104113827935"></p>
<p>SOA特性：</p>
<ul>
<li>逻辑视图：SOA是实际程序，数据库，商业流程的逻辑视图</li>
<li>基于消息：人不必知道实现服务代理如何构造的</li>
<li>基于描述：服务由元数据描述，只包括哪些公开可访问并对服务应用很重要的细节<ul>
<li>粒度：服务倾向使用少量的操作，使用大而复杂的信息</li>
<li>网络方向：服务往往是在网络上沿着使用的方向，尽管不是必须</li>
<li>平台中立性：标准化格式通过接口发送，XML</li>
</ul>
</li>
</ul>
<p>web服务时SOA最常见实例之一</p>
<h4 id="REST和系统的系统"><a href="#REST和系统的系统" class="headerlink" title="REST和系统的系统"></a>REST和系统的系统</h4><p>REST是应用于分布式系统的软件体系结构风格，基于以下四个基本原则</p>
<ul>
<li>通过URI的资源标识：标识与客户端进行交互的目标</li>
<li>统一的受限接口：通过客户端、服务器可缓存的协议标准进行交互</li>
<li>自我描述的信息：消息包含足够的信息来描述如何处理</li>
<li>无状态的交互：不依赖会话状态</li>
</ul>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210104132219474.png" alt="image-20210104132219474"></p>
<h4 id="WEB的核心技术"><a href="#WEB的核心技术" class="headerlink" title="WEB的核心技术"></a>WEB的核心技术</h4><p>简单对象访问协议（SOAP）提供标准封装结构用在不同协议中传输xml</p>
<p>WEB服务描述语言（WSDL）描述了接口，标准化了操作的输入和输出参数的表示以及服务协议绑定，</p>
<p>通用描述发现和集成（UDDI）提供通过搜索名称、标识符、类别、或Web服务实现的规范来广告和发现Web服务的全局注册表</p>
<h4 id="企业多层体系结构"><a href="#企业多层体系结构" class="headerlink" title="企业多层体系结构"></a>企业多层体系结构</h4><p>企业应用程序用多重体系结构封装各种功能。</p>
<p>多层体系机构基于C/S，最简单的是两层，也就是C/S，传统的服务器集群在维修升级部署时需要服务器下线，并且胖客户端环境下新应用增强部署消耗时间，降低可用性</p>
<p>三层系统包含：</p>
<ul>
<li>表述层：向外部实体描述信息，允许通过提交操作和获得响应和系统交互</li>
<li>商业、应用逻辑层或中间件：可控制用户认证，访问资源，完成一些客户端查询处理</li>
<li>资源管理层/数据层：处理实现信息系统的不同数据源</li>
</ul>
<h4 id="网络服务和OGSA"><a href="#网络服务和OGSA" class="headerlink" title="网络服务和OGSA"></a>网络服务和OGSA</h4><p>开放网络服务体系结构（OGSA）旨在为基于网格的应用定义一个通用的开放的体系结构，意图在于：</p>
<ul>
<li><p>便于在分布式的异构环境上使用和管理资源。</p>
</li>
<li><p>提供无缝的服务质量。</p>
</li>
<li><p>为了提供不同资源之间的互操作性，定义开放的发布接口。</p>
</li>
<li><p>采用工业标准的集成技术。</p>
</li>
<li><p>开发实现互操作性的标准。282283</p>
</li>
<li><p>在分布式的异构环境中集成、虚拟化和管理各种服务与资源。</p>
</li>
<li><p>提供松耦合的可交互服务，并且满足工业可接受的Web服务标准。</p>
</li>
</ul>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210104143018926.png" alt="image-20210104143018926"></p>
<h3 id="5-2-面向消息的中间件"><a href="#5-2-面向消息的中间件" class="headerlink" title="5.2 面向消息的中间件"></a>5.2 面向消息的中间件</h3><h4 id="企业总线"><a href="#企业总线" class="headerlink" title="企业总线"></a>企业总线</h4><p>企业服务总线（ESB）指总线支持许多组件，采用不同风格能够方便的集成到一起，在源和目的之间开一个通道，把带有足够信息的消息注入总线</p>
<h4 id="发布订阅模型和通知"><a href="#发布订阅模型和通知" class="headerlink" title="发布订阅模型和通知"></a>发布订阅模型和通知</h4><p>“发布-订阅”概念对于消息总线，描述源和目的连接起来的特殊模型，在发布者上贴上标签，与词汇表里主题名词管理，消息的接受者会接收到他们希望接收的相关消息，或者可以给予内容发布系统（SQL）查询</p>
<p>使用基于主题或内容的消息选择称为消息过滤</p>
<h3 id="5-3-门户和科学网关"><a href="#5-3-门户和科学网关" class="headerlink" title="5.3 门户和科学网关"></a>5.3 门户和科学网关</h3><p>网关是更复杂的实体，科学网关也称门户</p>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210104150739351.png" alt="image-20210104150739351"></p>
<h3 id="5-4-发现、注册表、元数据和数据库"><a href="#5-4-发现、注册表、元数据和数据库" class="headerlink" title="5.4 发现、注册表、元数据和数据库"></a>5.4 发现、注册表、元数据和数据库</h3><p>注册表是复杂的命名和目录服务：为了存储元数据，有一套数据结构规范，为了存储主，包含和归类服务元数据，要一套操作来存储，删除和查找数据。</p>
<p>注册表包含三类信息：</p>
<p>白页：实体名字和一般联系信息</p>
<p>黄页：条目提供服务类型和位置分类信息</p>
<p>绿页：如何调用所提供服务的详细信息</p>
<h4 id="UDDI和服务注册表"><a href="#UDDI和服务注册表" class="headerlink" title="UDDI和服务注册表"></a>UDDI和服务注册表</h4><p>UDDI（统一描述发现和集成）创建平台无关的开放框架定义一种描述发布WEb服务信息的方法。提供名字和目录服务爱通过名字或特定属性查找服务描述</p>
<p>注册表有两类</p>
<ul>
<li>公共注册表：逻辑的集中式分布服务，彼此在一个约定的基础上传数据。</li>
<li>私有注册表：单个组织内部访问，或特定目的的商业伙伴共享</li>
</ul>
<h4 id="数据库和订阅-发布"><a href="#数据库和订阅-发布" class="headerlink" title="数据库和订阅-发布"></a>数据库和订阅-发布</h4><p>订阅-发布是分布式应用实现异步交互的设计模式</p>
<p>防止轮询查询数据库，时间订阅者注册某个事件类型，发布者产生这样的事件时，订阅者从发布者得到通知，订阅者与发布者是多对多的关系。为数据库的静态本质增加了动态性。</p>
<p>分为基于主题的和基于内容的。</p>
<p>数据库提供基于消息传递的体系结构，可以使用许多特性，例如可靠的存储，事物和触发器。</p>
<h4 id="元数据目录"><a href="#元数据目录" class="headerlink" title="元数据目录"></a>元数据目录</h4><p>元数据是关于数据的信息，识别，定位和解释数据，为数据增加上下文。</p>
<p>网格上的关键元数据包括数据源的名称和位置、在这些数据源中数据的结构，数据项名称和描述以及用户信息或者可用服务的基本列表和简单查找。</p>
<h4 id="语义Web和网络"><a href="#语义Web和网络" class="headerlink" title="语义Web和网络"></a>语义Web和网络</h4><p>语义Web是关于自动化发现和集成的：给数据增加机器可处理语义，让机器理解并代表终端处理。从而基于为Web页面附加丰富元数据使web搜索链接更智能。</p>
<p>语义Web旨在提供一个环境，在里面软件代理能够动态的发现，询问和互操作资源并代替人执行复杂任务。</p>
<h4 id="作业执行环境和监控"><a href="#作业执行环境和监控" class="headerlink" title="作业执行环境和监控"></a>作业执行环境和监控</h4><p>分布式作业执行环境包括：作业执行引擎（处理作业调度，资源分配与容错）和分布式数据管理系统（为作业访问分布式数据提供抽象）。</p>
<h3 id="5-5-面向服务的体系结构工作流"><a href="#5-5-面向服务的体系结构工作流" class="headerlink" title="5.5 面向服务的体系结构工作流"></a>5.5 面向服务的体系结构工作流</h3><h4 id="工作流基本概念"><a href="#工作流基本概念" class="headerlink" title="工作流基本概念"></a>工作流基本概念</h4><p>对服务之间交互进行编程的方法。意味着分布式两层编程模型，基本服务采用传统语言编程，描述了服务之间彼此交互的粗粒度编程。他们之间的交互用工作流描述。</p>
<h4 id="工作流标准"><a href="#工作流标准" class="headerlink" title="工作流标准"></a>工作流标准</h4><h4 id="工作流体系和规范"><a href="#工作流体系和规范" class="headerlink" title="工作流体系和规范"></a>工作流体系和规范</h4><p>两个关键组件：工作流规范和工作流运行引擎，通过接口互相连接</p>
<h4 id="工作流运行引擎"><a href="#工作流运行引擎" class="headerlink" title="工作流运行引擎"></a>工作流运行引擎</h4><p>有向无环图，</p>
<p>使用传统语言和工具集的脚本是构建工作流的主要技术</p>
<p>最复杂的工作流支持层次化规范，即工作流节点可以是服务或服务集。</p>
<h2 id="第六章-云编程和软件环境"><a href="#第六章-云编程和软件环境" class="headerlink" title="第六章 云编程和软件环境"></a>第六章 云编程和软件环境</h2><h3 id="6-1-云和网络平台的特性"><a href="#6-1-云和网络平台的特性" class="headerlink" title="6.1 云和网络平台的特性"></a>6.1 云和网络平台的特性</h3><p><img src="/2021/01/03/Distributed-cloud-computing/image-20210104165649219.png" alt="image-20210104165649219"></p>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210104165659938.png" alt="image-20210104165659938"></p>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210104165707706.png" alt="image-20210104165707706"></p>
<p><img src="/2021/01/03/Distributed-cloud-computing/image-20210104165716339.png" alt="image-20210104165716339"></p>
<h4 id="网络和云的公共传统特征"><a href="#网络和云的公共传统特征" class="headerlink" title="网络和云的公共传统特征"></a>网络和云的公共传统特征</h4><p>工作流：在真实应用中工作流按需连接多个云和非云服务</p>
<p>数据传输：商业云中的数据传输成本</p>
<p>云编程环境的安全隐私和可用性需求：</p>
<ul>
<li>使用虚拟集群化实现最小开销成本达到资源动态供应</li>
<li>使用稳定和持续数据传输，带有用于信息检索的快速查询</li>
<li>特殊API来验证用户</li>
<li>使用HTTPS或者SSL等安全协议访问云资源</li>
<li>细粒度保护数据完整性，阻止入侵者或黑客</li>
<li>保护共享数据集</li>
<li>实时迁移和灾难恢复</li>
<li>使用信用系统保护数据中心</li>
</ul>
<h4 id="数据特性和数据库"><a href="#数据特性和数据库" class="headerlink" title="数据特性和数据库"></a>数据特性和数据库</h4><p>程序库：允许方便部署配置镜像（即支持IaaS）</p>
<p>Blob和驱动：类似共享文件系统</p>
<p>DPFS：这个文件系统是为执行数据密集型应用设计的</p>
<p>SQL和关系型数据库</p>
<p>表格和NOSQL非关系型数据库</p>
<p>队列服务：扩展组件间通信</p>
<h3 id="6-2-并行和分布式编程范式"><a href="#6-2-并行和分布式编程范式" class="headerlink" title="6.2 并行和分布式编程范式"></a>6.2 并行和分布式编程范式</h3><p>是运行在多个计算引擎或一个分布式计算系统上的并行程序，包含分布式系统和并行计算。分布式系统是一系列网络连接的计算引擎，完成一个共同目标：运行一个作业或者应用。并行计算时同时用多个引擎运行作业或者应用。</p>
<h4 id="并行计算和编程范式"><a href="#并行计算和编程范式" class="headerlink" title="并行计算和编程范式"></a>并行计算和编程范式</h4><p>多个网络节点或工作机组成用并行或者分布式方式来运行并行的程序，包括以下方面</p>
<ul>
<li><p>分区 分为识别分区和计算分区</p>
<ul>
<li>计算分区：将指定任务分割为小任务，分区过程很大程度依靠正确识别可以并发执行的作业或程序的每一小部分</li>
<li>数据分区：将输入或中间数据分割成更小部分。类似地，一旦识别出输入数据的并行性，它也可以被分割成多个部分，能在不同的工作机上运行。数据块可由程序的不同部分或者同一程序的副本来处理。</li>
</ul>
</li>
<li><p>映射：把更小的程序部分或更小的数据分块分给底层的资源，过程目的在于合理分配这些部分或者分块，使它们能同时在不同的工作机上运行。由系统中的资源分配器处理</p>
</li>
<li><p>同步：不同工作机可以执行不同任务，工作机之间同步和协同很有必要。可以避免竞争条件，不同工作机之间数据依赖也能恰当的管理。然而，一个工作机需要其他工作机处理的数据时会产生数据依赖</p>
</li>
<li><p>通信：中间数据转备好在工作机之间传送时通信就开始了</p>
</li>
<li><p>调度：数据块多于可用工作机数量时，调度程序选择一个任务序列分配给工作机。只基于一套称为调度策略的规则，对于多作业或多程序，调度器会选择运行在分布式系统上的一个任务或程序序列。</p>
</li>
</ul>
<h4 id="编程范式动机"><a href="#编程范式动机" class="headerlink" title="编程范式动机"></a>编程范式动机</h4><ul>
<li><p>提供并行或分布式范式或模型来抽象用户数据流的多个部分</p>
</li>
<li><p>编写并行程序的简单性是度量并行和分布式编程范式的重要标准。</p>
<ul>
<li>提高程序员效率</li>
<li>减少程序进入市场时间</li>
<li>有效利用系统资源</li>
<li>提高吞吐量</li>
<li>支持更高层抽象</li>
</ul>
</li>
<li><p>MapReduce、Hadoop和Dryad是最近提出的三种并行和分布式编程模型，为信息检索而开发。</p>
</li>
</ul>

      
    </div>
    
      
    
  </section>
</article>

          </div>
        
      
    
  </section>
  
    
    <!-- 根据主题中的设置决定是否在archive中针对摘要部分的MathJax公式加载mathjax.js文件 -->
    
    

  


	
</div>
<aside class='l_side'>
  
  
    
    

<section class="widget blogger shadow desktop mobile">
  <div class='content'>
    
      
        <a class='avatar flat-box rectangle' href='/about/'>
          <img no-lazy src='https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/blog/Logo-NavBar@3x.png'/>
        </a>
      
    
    
      <div class='text'>
        
        
        
          <p><span id="jinrishici-sentence">Yokeso</span></p>
          <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
        
      </div>
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="mailto:me@xxx.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://github.com/volantis-x/"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://music.163.com/#/user/home?id=63035382"
              class="social fas fa-headphones-alt flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

  

  
    
    

  

  
    
    
  

  <section class="widget tagcloud shadow desktop mobile">
    
  <header>
    
      <a href='/blog/tags/'><i class="fas fa-tags fa-fw" aria-hidden="true"></i><span class='name'>热门标签</span></a>
    
  </header>


    <div class='content'>
      <a href="/tags/CCF/" style="font-size: 14px; color: #999">-CCF</a> <a href="/tags/DSP-2020-lunboli/" style="font-size: 14px; color: #999">-DSP -2020 -lunboli</a> <a href="/tags/Hexo-%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" style="font-size: 14px; color: #999">-Hexo -个人博客</a> <a href="/tags/OS-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-ch3/" style="font-size: 14px; color: #999">-OS -操作系统 -ch3</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-OS-ch2/" style="font-size: 14px; color: #999">-操作系统 -OS -ch2</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-OS-ch3/" style="font-size: 14px; color: #999">-操作系统 -OS -ch3</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 14px; color: #999">计算机网络</a>
    </div>
  </section>


  

  


</aside>





	<!-- 根据主题中的设置决定是否在archive中针对摘要部分的MathJax公式加载mathjax.js文件 -->
	

	


    </div>
    
  
  <footer class="clearfix">
    <br><br>
    
      
        <div class="aplayer-container">
          

  
    <meting-js
      theme='#1BCDFC'
      autoplay='false'
      volume='0.7'
      loop='all'
      order='list'
      fixed='false'
      list-max-height='320px'
      server='netease'
      type='playlist'
      id='3175833810'
      list-folded='true'>
    </meting-js>
  


        </div>
      
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="/atom.xml"
                class="social fas fa-rss flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="mailto:me@xxx.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://github.com/volantis-x/"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://music.163.com/#/user/home?id=63035382"
                class="social fas fa-headphones-alt flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        <div><p>Blog content follows the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) License</a></p>
</div>
      
    
      
        Use
        <a href="https://github.com/volantis-x/hexo-theme-volantis/tree/3.0.0" target="_blank" class="codename">Volantis</a>
        as theme, total visits
          <span id="busuanzi_value_site_pv"><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span>
          times
        
      
    
      
        <div class='copyright'>
        <p><a href="/">Copyright © 2017-2020 XXX</a></p>

        </div>
      
    
  </footer>


    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <div>
    
      
  

  <div id="rightmenu-wrapper">
    <ul class="list-v rightmenu" id="rightmenu-content">
      <li class='option'>
        <a class='vlts-menu opt fix-cursor-default' id='menu-copy-text' onclick='document.execCommand("copy")'><i class='fa fa-copy fa-fw'></i>Copy Text</a>
        <hr id='hr-text'>
        <a class='vlts-menu opt fix-cursor-default' id='menu-copy-href'><i class='fa fa-link fa-fw'></i>Copy Link</a>
        <a class='vlts-menu opt fix-cursor-default' id='menu-open-href'><i class='fa fa-external-link-square-alt fa-fw'></i>Open Link in New Tab</a>
        <hr id='hr-href'>
        <a class='vlts-menu opt fix-cursor-default' id='menu-copy-src'><i class='fa fa-image fa-fw'></i>Copy Image Link</a>
        <hr id='hr-src'>
      </li>
      
        <li class='navigation'>
          <a class='nav icon-only fix-cursor-default' onclick='history.back()'><i class='fa fa-arrow-left fa-fw'></i></a>
          <a class='nav icon-only fix-cursor-default' onclick='history.forward()'><i class='fa fa-arrow-right fa-fw'></i></a>
          <a class='nav icon-only fix-cursor-default' onclick='window.location.reload()'><i class='fa fa-redo fa-fw'></i></a>
          <a class='nav icon-only fix-cursor-default' href='/'><i class='fa fa-home fa-fw'></i></a>
        </li>
      
      <hr>
      
        
      
        
          
    <li>
      <a class='vlts-menu fix-cursor-default' href=https://volantis.js.org/faqs/
        
        
        
        
          id="https:volantisjsorgfaqs"
        >
        <i class='fa fa-question fa-fw'></i> 常见问题
      </a>
    </li>
  
        
      
        
          
    <li>
      <a class='vlts-menu fix-cursor-default' href=https://volantis.js.org/examples/
        
        
        
        
          id="https:volantisjsorgexamples"
        >
        <i class='fa fa-rss fa-fw'></i> 示例博客
      </a>
    </li>
  
        
      
        
          
    <li>
      <a class='vlts-menu fix-cursor-default' href=https://volantis.js.org/contributors/
        
        
        
        
          id="https:volantisjsorgcontributors"
        >
        <i class='fa fa-fan fa-spin fa-fw'></i> 加入社区
      </a>
    </li>
  
        
      
        
          <hr>
        
      
        
          
    <li>
      <a class='vlts-menu fix-cursor-default' href=https://github.com/volantis-x/volantis-docs/
        
        
        
        
          id="https:githubcomvolantis-xvolantis-docs"
        >
        <i class='fa fa-code-branch fa-fw'></i> 本站源码
      </a>
    </li>
  
        
      
        
          
    <li>
      <a class='vlts-menu fix-cursor-default' href=https://github.com/volantis-x/hexo-theme-volantis/
        
        
        
        
          id="https:githubcomvolantis-xhexo-theme-volantis"
        >
        <i class='fa fa-code-branch fa-fw'></i> 主题源码
      </a>
    </li>
  
        
      
        
          <hr>
        
      
        
          
    <li>
      <a class='vlts-menu fix-cursor-default' 
        
        
        
          onclick="document.execCommand('print')"
        
        >
        <i class='fa fa-print fa-fw'></i> 打印页面
      </a>
    </li>
  
        
      
        
          <hr>
        
      
        
          <li class='music name'>
            <p class='nav music-title fix-cursor-default'></p>
          </li>
          <li class='music ctrl'>
            <a class='nav icon-only backward fix-cursor-default' onclick='aplayerBackward()'><i class='fa fa-step-backward fa-fw'></i></a>
            <a class='nav icon-only toggle fix-cursor-default' onclick='aplayerToggle()'><i class='fa fa-play fa-fw'></i></a>
            <a class='nav icon-only forward fix-cursor-default' onclick='aplayerForward()'><i class='fa fa-step-forward fa-fw'></i></a>
          </li>
          <li class='music volume'>
            <a class='nav volume'>
              <div class="aplayer-volume-bar-wrap">
                <div class="aplayer-volume-bar fix-cursor-pointer">
                  <div class="aplayer-volume"></div>
                  <i class='left fa fa-volume-off fa-fw'></i>
                  <i class='right fa fa-volume-up fa-fw'></i>
                </div>
              </div>
            </a>
          </li>
        
      
    </ul>
  </div>

  <script>
    window.document.oncontextmenu = function (event) {
      if (event.ctrlKey) return true;
      if (/Android|webOS|BlackBerry/i.test(navigator.userAgent)) return true;
      return popMenu(event);
    };
    document.addEventListener("click", function (event) {
      var mymenu = document.getElementById('rightmenu-wrapper');
      mymenu.style.display = "none";
    });
    function popMenu(event) {
      var mymenu = document.getElementById('rightmenu-wrapper');
      var menuContent = document.getElementById('rightmenu-content');
      var screenWidth = document.documentElement.clientWidth || document.body.clientWidth;
      var screenHeight = document.documentElement.clientHeight || document.body.clientHeight;
      mymenu.style.left = event.clientX + "px"; // 获取鼠标位置
      mymenu.style.top = event.clientY + "px";
      mymenu.style.display = 'block';
      if (event.clientX * 2 > screenWidth) {
        menuContent.classList.add('left');
      } else {
        menuContent.classList.remove('left');
      }
      if (event.clientY * 2 > screenHeight) {
        menuContent.classList.add('top');
      } else {
        menuContent.classList.remove('top');
      }

      let hrText = document.getElementById('hr-text');
      let hrSrc = document.getElementById('hr-src');
      let hrHref = document.getElementById('hr-href');

      // 选中图片
      let copySrc = document.getElementById('menu-copy-src');
      if (copySrc != undefined) {
        if (event.target.currentSrc) {
          copySrc.style.display = 'block';
          copySrc.addEventListener("click", function (e) {
            copyString(event.target.currentSrc);
          },{once: true});
          hrSrc.style.display = 'block';
        } else {
          copySrc.style.display = 'none';
          hrSrc.style.display = 'none';
        }
      }

      // 选中按钮
      // 判断是不是按钮
      let href = '';
      if (event.path) {
        for (i = 0; i < event.path.length; i++) {
          if (event.path[i].href != undefined && event.path[i].href.length > 0) {
            href = event.path[i].href;
          }
        }
      }

      let copyText = document.getElementById('menu-copy-text');
      copyText.style.display = 'none';
      hrText.style.display = 'none';
      if (href.length == 0) {
        // 选中文本
        if (window.getSelection().toString()) {
          copyText.style.display = 'block';
          hrText.style.display = 'block';
        }
      }

      // 在新标签页打开
      let openHref = document.getElementById('menu-open-href');
      if (openHref != undefined) {
        if (href.length > 0) {
          openHref.style.display = 'block';
          openHref.addEventListener("click", function (e) {
            window.open(href);
          },{once: true});
          hrHref.style.display = 'block';
        } else {
          openHref.style.display = 'none';
          hrHref.style.display = 'none';
        }
      }
      // 复制链接
      let copyHref = document.getElementById('menu-copy-href');
      if (copyHref != undefined) {
        if (href.length > 0) {
          copyHref.style.display = 'block';
          copyHref.addEventListener("click", function (e) {
            copyString(href);
          },{once: true});
        } else {
          copyHref.style.display = 'none';
        }
      }

      // 有音乐播放器
      if (true == true) {
        // 如果有aplayer，初始化一下
      	try {
      		checkAPlayer();
          updateTitle();
      	} catch (error) {
      		console.log(error);
      	}
      }

      return false; // 该行代码确保系统自带的右键菜单不会被调出
    }
    function hideMenu() {
      document.getElementById('rightmenu-wrapper').style.display = 'none';
    }
    function copyString(str) {
      const input = document.createElement('input');
      input.setAttribute('readonly', 'readonly');
      document.body.appendChild(input);
      input.setAttribute('value', str);
      input.select();
      document.execCommand('copy');
      document.body.removeChild(input);
    }
    document.execCommand('click');
  </script>


    
    <!-- required -->

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5/dist/jquery.min.js"></script>


<!-- optional -->

  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/001.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/002.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/003.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/004.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/005.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/006.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/012.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/016.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/019.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/025.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/033.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/034.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/035.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/038.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/039.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/042.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/046.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/051.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/052.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/054.jpg", "https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/056.jpg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "10000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "10000",
            fade: "1500"
          });
        }
      });
    </script>
  



  <script>
  
  var SEARCH_SERVICE = "hexo" || "hexo";
  var ROOT = "/" || "/";
  if (!ROOT.endsWith('/')) ROOT += '/';
</script>






  <script async src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>


<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  function pjax_fancybox() {
    $(".article-entry").find("img").not('.inline').not('a img').each(function () { //渲染 fancybox
      var element = document.createElement("a"); // a 标签
      $(element).attr("class", "fancybox");
      $(element).attr("pjax-fancybox", "");  // 过滤 pjax
      $(element).attr("href", $(this).attr("src"));
      if ($(this).attr("data-original")) {
        $(element).attr("href", $(this).attr("data-original"));
      }
      $(element).attr("data-fancybox", "images");
      var caption = "";   // 描述信息
      if ($(this).attr('alt')) {  // 判断当前页面是否存在描述信息
        $(element).attr('data-caption', $(this).attr('alt'));
        caption = $(this).attr('alt');
      }
      var div = document.createElement("div");
      $(div).addClass("fancybox");
      $(this).wrap(div); // 最外层套 div ，其实主要作用还是 class 样式
      var span = document.createElement("span");
      $(span).addClass("image-caption");
      $(span).text(caption); // 加描述
      $(this).after(span);  // 再套一层描述
      $(this).wrap(element);  // 最后套 a 标签
    })
    $(".article-entry").find("img").fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
      closeClick: true,
      helpers: {
        overlay: {closeClick: true}
      },
      buttons: [
        "zoom",
        "close"
      ]
    });
  };
  $(function () {
    pjax_fancybox();
  });
</script>


  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
    var clipboard = new ClipboardJS('.btn-copy', {
        target: function (trigger) {
            return trigger.nextElementSibling
        }
    });
    function wait(callback, seconds) {
        var timelag = null;
        timelag = window.setTimeout(callback, seconds)
    }
    function pjax_initCopyCode() {
        var copyHtml = '';
        copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
        copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
        copyHtml += '</button>';
        $(".highlight .code pre").before(copyHtml);
        $(".article pre code").before(copyHtml);
        clipboard.off('success').on('success', function (e) {
            let $btn = $(e.trigger);
            $btn.addClass('copied');
            let $icon = $($btn.find('i'));
            $icon.removeClass('fa-copy');
            $icon.addClass('fa-check-circle');
            let $span = $($btn.find('span'));
            $span[0].innerText = 'COPIED';
            wait(function () {
                $icon.removeClass('fa-check-circle');
                $icon.addClass('fa-copy');
                $span[0].innerText = 'COPY'
            }, 2000)
        });
        clipboard.off('error').on('error', function (e) {
            e.clearSelection();
            let $btn = $(e.trigger);
            $btn.addClass('copy-failed');
            let $icon = $($btn.find('i'));
            $icon.removeClass('fa-copy');
            $icon.addClass('fa-times-circle');
            let $span = $($btn.find('span'));
            $span[0].innerText = 'COPY FAILED';
            wait(function () {
                $icon.removeClass('fa-times-circle');
                $icon.addClass('fa-copy');
                $span[0].innerText = 'COPY'
            }, 2000)
        })
    }
    $(function () {
        pjax_initCopyCode()
    });
</script>



   <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.6/dist/scrollreveal.min.js"></script>
<script type="text/javascript">
  function pjax_scrollrebeal() {
    ScrollReveal().reveal('.l_main .reveal', {
      distance: '32px',
      duration: '800',
      interval: '20',
      scale: '1',
      easing: 'ease-out'
    });
  }
  $(function () {
    pjax_scrollrebeal();
  });
</script>




  <script>
  let APlayerController = new Object();
  APlayerController.id = '3175833810';  // 设定全局音乐播放ID
  APlayerController.volume = '0.7';
</script>

  
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js"></script>


  
<script src="https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js"></script>


  
<script src="/js/aplayer.js"></script>






  
  
<script src="/js/valine.js"></script>


<script>
  var GUEST_INFO = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link'.split(',').filter(function (item) {
    return GUEST_INFO.indexOf(item) > -1
  });
  var REQUIRED_FIELDS = ['nick', 'mail', 'link'];
  var requiredFields = 'nick,mail'.split(',').filter(function (item) {
    return REQUIRED_FIELDS.indexOf(item) > -1
  });

  function emoji(path, idx, ext) {
    return path + "/" + path + "-" + idx + "." + ext;
  }

  var emojiMaps = {};
  for (var i = 1; i <= 54; i++) {
    emojiMaps['tieba-' + i] = emoji('tieba', i, 'png');
  }
  for (var i = 1; i <= 101; i++) {
    emojiMaps['qq-' + i] = emoji('qq', i, 'gif');
  }
  for (var i = 1; i <= 116; i++) {
    emojiMaps['aru-' + i] = emoji('aru', i, 'gif');
  }
  for (var i = 1; i <= 125; i++) {
    emojiMaps['twemoji-' + i] = emoji('twemoji', i, 'png');
  }
  for (var i = 1; i <= 4; i++) {
    emojiMaps['weibo-' + i] = emoji('weibo', i, 'png');
  }

  function pjax_valine() {
    let pageUrl = $.trim($('#pjax-comment-path').text()) === "none" ? 
      decodeURI(window.location.pathname) : $.trim($('#pjax-comment-path').text());
    let pagePlaceholder = $.trim($('#pjax-comment-placeholder').text()) === "none" ?
      "快来评论吧~" : $.trim($('#pjax-comment-placeholder').text());

    let ALLPATH = '';
    if(ALLPATH != '') pageUrl = ALLPATH;

    var valine = new Valine();
    valine.init({
      el: '#valine_container',
      meta: meta,
      placeholder: pagePlaceholder,
      path: pageUrl,
      appId: "",
      appKey: "",
      pageSize: '10',
      avatar: 'robohash',
      lang: 'zh-cn',
      visitor: 'true',
      highlight: 'true',
      mathJax: 'false',
      enableQQ: 'true',
      requiredFields: requiredFields,
      emojiCDN: 'https://cdn.jsdelivr.net/gh/volantis-x/cdn-emoji/valine/',
      emojiMaps: emojiMaps
    })
  }

  $(function () {
    pjax_valine();
  });
</script>






  <script defer src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js" data-pjax></script>


  
<script src="/js/app.js"></script>




  
    
<script src="/js/search.js"></script>

  




  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function () {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>







<!-- more -->


    
      


<script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script>

<!-- 样式位于：source/css/_third-party/pjaxanimate.styl -->

<div class="pjax-animate">
  
    <script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>
    <div id="loading-bar-wrapper"><script>NProgress.configure({parent:"#loading-bar-wrapper",trickleSpeed: 100})</script></div>
    <script>
      window.ShowLoading = function() {
        NProgress.start();
      };
      window.HideLoading = function() {
        NProgress.done();
      }
    </script>
  
</div>

<script>
    var pjax;
    document.addEventListener('DOMContentLoaded', function () {
      pjax = new Pjax({
        elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([pjax-fancybox])',
        selectors: [
          "title",
          "#pjax-container",
          "#pjax-header-nav-list"
        ],
        cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
        timeout: 5000
      });
    });

    document.addEventListener('pjax:send', function (e) {
      window.stop(); // 相当于点击了浏览器的停止按钮

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      window.subData = null; // 移除标题（用于一二级导航栏切换处）
      $.fancybox.close();    // 关闭弹窗
      $('.l_header .switcher .s-search').removeClass('active'); // 关闭移动端激活的搜索框
      $('.l_header').removeClass('z_search-open'); // 关闭移动端激活的搜索框
      $('.wrapper').removeClass('sub'); // 跳转页面时关闭二级导航

      // 解绑事件 避免重复监听
      $('.s-top').unbind('click');
      $('.menu a').unbind('click');
      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');
      window.ShowLoading();
    });

    document.addEventListener('pjax:complete', function () {
      // 关于百度统计对 SPA 页面的处理：
      // 方案一：百度统计>管理>单页应用设置中，打开开启按钮即可对SPA进行统计。 https://tongji.baidu.com/web/help/article?id=324
      // 方案二：取消注释下列代码。 https://tongji.baidu.com/web/help/article?id=235
      // 

      // 关于谷歌统计对 SPA 页面的处理：
      // 当应用以动态方式加载内容并更新地址栏中的网址时，也应该更新通过 gtag.js 存储的网页网址。
      // https://developers.google.cn/analytics/devguides/collection/gtagjs/single-page-applications?hl=zh-cn
      

      $('.nav-main').find('.list-v').not('.menu-phone').removeAttr("style",""); // 移除小尾巴的移除
      $('.menu-phone.list-v').removeAttr("style",""); // 移除小尾巴的移除
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });
      try{
        pjax_fancybox();
        
          
          if ('.cover') {
            $('.cover').backstretch("resize");
          } else {
            $.backstretch("resize");
          }
        
        
        
          pjax_scrollrebeal();
        
        
          pjax_initCopyCode();
        
        
          pjax_valine();
        
        
        
        
        
      } catch (e) {
        console.log(e);
      }
      window.HideLoading();
    });

    document.addEventListener('pjax:error', function (e) {
      window.HideLoading();
      window.location.href = e.triggerElement.href;
    });
</script>

    
  </div>
</body>
</html>
